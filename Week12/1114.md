# 1114 ì •ë¦¬

### Spring MVC

<br/>

**IntelliJ ì—ì„œ Get from VCS ë¡œ í”„ë¡œì íŠ¸ ìƒì„±**
- URL : https://github.com/dongmyo/academy-spring-mvc


<br/>

**ApplicationContext vs WebApplicationContext**
- WebApplicationContext = ApplicationContext + ServletContext

<br/>

**`@EnableWebMvc`**
- Spring MVCì˜ ê¸°ë³¸ ì„¤ì • ì• ë…¸í…Œì´ì…˜

<Br/>

**ê¸°ë³¸ ì„¤ì • (xml)**

<details>
    <summary> pom.xml </summary>

```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-framework-bom</artifactId>
            <version>5.3.13</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>

<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-webmvc</artifactId>
</dependency>

<dependency>
    <groupId>jakarta.servlet</groupId>
    <artifactId>jakarta.servlet-api</artifactId>
    <version>4.0.4</version>
    <scope>provided</scope>
</dependency>
```

</details>


<br/>

**ê¸°ë³¸ ì„¤ì •(Java)**

- `@ComponentScan`ì˜ ìœ„ì¹˜ë¥¼ ì¡ì•„ì£¼ëŠ” ì¸í„°í˜ì´ìŠ¤
- ìœ„ì¹˜ë¥¼ ì¡ì•„ì£¼ëŠ” ì—­í•  ì´ì™¸ì— ì–´ëŠ ì—­í• ë„ í•˜ì§€ ì•ŠìŒ
    - Base
    - Controller Base

```java
public interface Base {
}

public interface ControllerBase {
}
```

<br/>

- `WebAppInitializer` (`web.xml` ëŒ€ì²´)
- `AbstractAnnotationConfigDispatcherServletInitializer` ì˜¤ë²„ë¼ì´ë”© í•˜ë©´ ë¨
<details>
    <summary>WebAppInitializer </summary>

```java
public class WebAppInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {
    @Override
    protected String[] getServletMappings() {
        return new String[] { "/" };
    }

    @Override
    protected Class<?>[] getRootConfigClasses() {
        return new Class[] { RootConfig.class };
    }

    @Override
    protected Class<?>[] getServletConfigClasses() {
        return new Class[] { WebConfig.class };
    }
}
```

</details>

<br/>

- `RootConfig` class
- **Root ApplicationContext**ìš© `@Configuration`

<details>
    <summary> RootConfig </summary>

```java
@Configuration
@ComponentScan(basePackageClasses = Base.class,
    excludeFilters = { @ComponentScan.Filter(Controller.class)})
public class RootConfig {
}
```

</details>

<br/>

- `WebConfig` class
- **Servlet ApplicationContext** ìš© `@Configuration`

<details>
    <summary> WebConfig </summary>

```java
@EnableWebMvc
@Configuration
@ComponentScan(basePackageClasses = ControllerBase.class)
public class WebConfig implements WebMvcConfigurer {
    @Override
    public void configureViewResolvers(ViewResolverRegistry registry) {
        registry.jsp("/WEB-INF/view/", ".jsp");
    }
}
```

</details>

---
### View
- jsp ì‚¬ìš©


---
### Controller

<br/>

- MVC íŒ¨í„´ì—ì„œ `Controller` ì—­í• 
    - ìš”ì²­ ì²˜ë¦¬ ë° íë¦„ ì œì–´ ë‹´ë‹¹

<Br/>

**`@Controller`**
- stereotype type bean ì¤‘ í•˜ë‚˜ : `@ComponentScan`ìœ¼ë¡œ ìë™ìœ¼ë¡œ Bean ë“±ë¡
```java
@Controller                         // <-- Controller ì„ì„ ì§€ì •
public class HomeController {
    @GetMapping("/")                // <-- HTTP Method ì§€ì •, URL ë§µí•‘
    public String index() {
        return "index";             // <-- view ì´ë¦„ ì§€ì •
    }
}
```

<br/>

**`@RestController`**
- `@Controller` + `@ResponseBody`
- `@Controller`ëŠ” view ì´ë¦„ì„ ë°˜í™˜ -> `ViewResolver`ê°€ view ì²˜ë¦¬
- `@RestController`ëŠ” `HttpMessageConverter`ê°€ ì‘ë‹µ ê°ì²´ë¥¼ ì²˜ë¦¬
```java
@RestController
@RequestMapping("/persons")
public class PersonController {
    /*
            GET /persons/12345

            HTTP/1.1 200 OK
            Content-type: application/json;charset=UTF-8

            {
                "name": "dongmyo",
                "age": 19,
                "address": "Ulsan, Korea"
            }
     */
    @GetMapping("/{id}")
    public Person getPerson(@PathVariable Long id) {
        // ...
    }

    /*
            POST /persons
            {
                "name": "dongmyo",
                "age": 19,
                "address": "Ulsan, Korea"
            }

            HTTP/1.1 201 Created
     */
    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    public void add(@RequestBody Person person) {
        // ...
    }
}
```

<br/>

**`@RequestMapping`**
- ìš”ì²­ì„ Controller ë©”ì„œë“œì— ë§¤í•‘
- `@GetMapping` == `@RequestMapping(method=RequestMethod.GET)`
- `@PostMapping` == `@RequestMapping(method=RequestMethod.POST)`
- `@PutMapping` == `@RequestMapping(method=RequestMethod.PUT)`
- `@DeleteMapping` == `@RequestMapping(method=RequestMethod.DELETE)`
- `@PatchMapping` == `@RequestMapping(method=RequestMethod.PATCH)`

<br/>

**Request Parameter ì—°ê²°**
- **id** parameter
```java
@RequestMapping(method = RequestMethod.GET, params = { "id" })
```

- id parameterê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ
```java
@GetMapping(params = { "!id" })
```

- type parameter ê°’ì´ rawì¸ ê²½ìš°ì—ë§Œ
```java
@GetMapping(params = "type=raw")
```

- type parameter ê°’ì´ rawê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ
```java
@GetMapping(params = "type!=raw")
```

<br/>

**Controller Methodì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ argument**
- HttpServletRequest, HttpServletResponse, HttpSession, WebRequest
- Locale
- InputStream, OutputStream, Reader, Writer
- `@PathVariable`, `@RequestParam`, `@RequetHeader`, `@CookieValue`, `@Value`
- Map, Model, ModelMap, `@ModelAttribute`, `@RequestBody`
- Errors, BindingResult, ...

<br/>

**Controller Methodì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ return type**
- ModelAndView, View
- Map, Model, ModelMap
- String
- void
- `@ResponseBody`
- POJO

<br/>

**`ModelAndView`**
- Model + View
- ì‚¬ìš© ì˜ˆì‹œ
    - `ModelAndView`ë¥¼ ë¦¬í„´
```java
@GetMapping("/some-request")
public ModelAndView doSomething() {
    ModelAndView mav = new ModelAndView("viewName");
    mav.addObject("name", "value");
    // ...

    return mav;
}
```

<br/>

**ìš”ì²­ Parameter ë°›ê¸°**
- `@Requestparam` ì‚¬ìš©
- ìš”ì²­ URLì˜ ì¿¼ë¦¬ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ì• ë…¸í…Œì´ì…˜
- ì˜ˆì‹œ URL
```
GET http://localhost:8080/persons?order=-createdAt
```

- Controller Method
```java
@GetMapping("/persons")
public List<Person> getPersons(@RequestParam(name="order") String order) {
    // ...
}
```

<br/>

**ìš”ì²­ URLì˜ ê°€ë³€ ì¸ì ë°›ê¸°**
- `@PathVariable`
- ìš”ì²­ URLì˜ Pathë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ì—ë…¸í…Œì´ì…˜
- ì—ì‹œ URL
```
GET http://localhost:8080/persons/19023
``` 
- Controller Method
```java
@GetMapping("/persons/{personId}")
public List<Person> getPersons(@PathVariable(name="personId", required=true) Long personId) {
    // ...
}
```

<br/>


**ìš”ì²­ Headerê°’ ë°›ê¸°**
- `@RequestHeader`
- HTTP í—¤ë”ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ì—ë…¸í…Œì´ì…˜
- ì˜ˆì‹œ ìš”ì²­
```
GET /some-request HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36
```
- Controller Method
```java
@GetMapping("/some-request")
public List<User> getUsers(@RequestHeader(name = "User-Agent") String userAgent) {
    // ...
}
```

<br/>

**Cookie ê°’ ê°€ì ¸ì˜¤ê¸°**
- `@CookieValue`
- HTTP ì¿ í‚¤ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ì• ë…¸í…Œì´ì…˜
```java
@GetMapping("/some-request")
public List<Person> getPersons(@CookieValue(name = "SESSION") String sessionId) {
    // ...
}
```

<Br>

---

**URL Pattern**
- Ant Style Pattern ì§€ì›
- `?` : 1ê¸€ì ë§¤ì¹­
- `*` : 0ê¸€ì ì´ìƒ ë§¤ì¹­
- `**` : 0ê¸€ì ì´ìƒ í•˜ìœ„ ê²½ë¡œ ë§¤ì¹­

<br/>


**ì˜ˆì™¸ ì²˜ë¦¬**
- `@ExceptionHandler`
- ì˜ˆì™¸ì²˜ë¦¬ ë©”ì„œë“œì— ì§€ì •
```java
@ExceptionHandler({UserNotFoundException.class})          // <-- ì–´ë–¤ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•  ê²ƒì¸ì§€ ì„ ì–¸
// --> method argumentë¡œ ì—¬ëŸ¬ ê°ì²´ë“¤ì„ ì„ ì–¸í•  ìˆ˜ ìˆë‹¤.
public String handleException(UserNotFoundException ex, HttpServletResponse response) {
    // ...

    // --> method return valueë¡œ ì—¬ëŸ¬ ê°ì²´ë“¤ì„ ë°˜í™˜í•  ìˆ˜ ìˆë‹¤.
    return "error";
}
```

<br/>


**`@ExceptionHandler` + `@ResponseStatus`**
```java
@ExceptionHandler(UserNotFoundException.class)
@ResponseStatus(HttpStatus.NOT_FOUND)
public void notFound() {
    // nothing to do
}
```

**`@ExceptionHandler` + View**
```java
@ExceptionHandler(UserNotFoundException.class)
@ResponseStatus(HttpStatus.NOT_FOUND)
public String notFound(UserNotFoundException ex, Model model) {
    model.addAttribute("exception", ex);
    return "error";
}
```

**`@ExceptionHandler` + `@ResponseBody` + `HttpMessageConverter`**
```java
@ExceptionHandler(Exception.class)
@ResponseBody
public ErrorDto handleException(Exception ex) {
    // ...
    // ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ê³  ì—ëŸ¬ ë©”ì„¸ì§€ë¥¼ ë‹´ì€ `ErrorDto` ê°ì²´ë¥¼ ìƒì„±í•´ì„œ ë°˜í™˜
    return errorDto;
}
```

**ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬**
- ì „ì²´ì ìœ¼ë¡œ ê¸°ë³¸ì ì¸ ì˜ˆì™¸ì²˜ë¦¬ ë‹´ë‹¹
```java
@ControllerAdvice
public class WebControllerAdvice {
    @ExceptionHandler({ UserNotFoundException.class, PostNotFoundException.class })
    public String handleException(Exception ex, Model model) {
        log.error("resource not found", ex);
        model.addAttribute("exception", ex);
        return "error";
    }
}
```

<br/>

**ì…ë ¥ ê°’ ê²€ì¦**
- Bean Validation
- pom.xml
```xml
<dependency>
    <groupId>jakarta.validation</groupId>
    <artifactId>jakarta.validation-api</artifactId>
    <version>2.0.2</version>
</dependency>

<dependency>
    <groupId>org.hibernate.validator</groupId>
    <artifactId>hibernate-validator</artifactId>
    <version>6.2.3.Final</version>
</dependency>
```

<br/>

**Validation ì ìš©**
- `@Valid` ì‚¬ìš©
```java
public String modifyUser(@Valid @ModelAttribute UserModifyRequest userRequest,
                         BindingResult bindingResult) {
    if (bindingResult.hasErrors()) {
        throw new ValidationFailedException(bindingResult);
    }
    // ...
}
```

---

### ê³¼ì œ
- URL : https://github.com/dongmyo/academy-spring-mvc
- score ë¸Œëœì¹˜ë¥¼ ë¨¼ì € ë¡œë“œ
```
git checkout score
```

<br/>

**í´ë˜ìŠ¤ ì‘ì„±**
- 3ê°œ í´ë˜ìŠ¤ êµ¬í˜„
    - `StudentRegisterController`
    - `StudentController`
    - `StudentRespositoryImpl`

<br/>

**Model ê´€ë ¨**
- `@ModelAttribute` ì‚¬ìš©
- Model, ModelMap, ModelAndView 1íšŒ ì´ìƒ ì‚¬ìš©

<br/>

**`GET /student/{studentId}?hideScore=yes`**
- ì´ ê²½ìš° ì ìˆ˜ ë…¸ì¶œ X
- `GET /student/{studentId}`ì™€ ë‹¤ë¥¸ ë©”ì„œë“œë¡œ ì‘ì„±

<br/>

**ë“±ë¡, ìˆ˜ì •ì‹œ ê²€ì¦**
- ì´ë¦„ : ë¬¸ìì—´ ê¸¸ì´ 0ë³´ë‹¤ í¼
- ì´ë©”ì¼ : ì´ë©”ì¼ í˜•ì‹
- ì ìˆ˜ : 0ì  ~ 100ì 
- í‰ê°€ : ë¬¸ìì—´ ê¸¸ì´ 0 ~ 200

<br/>

**ì—ëŸ¬ ì²˜ë¦¬**
- `GET /student/{studentId}`
- `GET /student/{studentId}/modify`
- ìœ„ ì ‘ê·¼ì— ì—†ëŠ” ë¦¬ì†ŒìŠ¤ì¼ ê²½ìš° 404 ì‘ë‹µ
- ê·¸ ì™¸ëŠ” `@ControllerAdvice`ë¡œ ì˜ˆì™¸ ì²˜ë¦¬

<br/>

**ì½”ë“œ**
- ì½”ë“œ ë§í¬ : [ë§í¬ ğŸ”‘](https://github.com/unhas01/nhnacademy/tree/master/Week12/academy-spring-mvc-student-v1)









