# 1130 ì •ë¦¬

### JPA 3ì¼ì°¨

<br/>

**Repository**
- `@Query`
- JPQL ì¿¼ë¦¬ë‚˜ Native ì¿¼ë¦¬ë¥¼ ì§ì ‘ ìˆ˜í–‰
    ```java
    @Query("select i from Item i where i.price > ?1")
    List<Item> getItemsHavingPriceAtLeast(long price);

    @Query(value = "select * from Items where price > ?1", nativeQuery = true)
    List<Item> getItemsHavingPriceAtLeast2(long price);
    ```
- `@Modifying`
    - `@Query`ë¥¼ í†µí•´ INSERT, DELETE, UPDATEì‹œ ë¶™ì—¬ì¤˜ì•¼í•¨
    ```java
    @Modifying
    @Query("update Item i set i.itemName = :itemName where i.itemId = :itemId")
    int updateItemName(@Param("itemId") Long itemId, @Param("itemName")String itemName);
    ```

<br/>

**DTO Project**
- Repository ë©”ì„œë“œê°€ Entityë¥¼ ë°˜í™˜í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì›í•˜ëŠ” í•„ë“œë§Œ ë½‘ì•„ì„œ DTOë¡œ ë°˜í™˜í•˜ëŠ” ê²ƒ
- ì¢…ë¥˜
    - Interface ê¸°ë°˜ Projection
        - *Datetimeê°™ì€ íƒ€ì…ë“¤ì€ ë°˜í™˜í•˜ëŠ” ê³¼ì •ì— ìˆì–´ ì–´ë–¤ ì„¤ì •ì´ í•„ìš”í•˜ì§€ë§Œ ì˜ ëª¨ë¥´ê² ì–´ì„œ Class ê¸°ë°˜ì„ ìì£¼ ì‚¬ìš©í–ˆìŒ*
    - Class ê¸°ë°˜ Projection
    - Dynamic Projection

<br/>

**Web Support**
- Spring Dataì—ì„œ ì œê³µí•˜ëŠ” Web í™•ì¥ ê¸°ëŠ¥
- `WebConfig`ì— `@EnableSpringDataWebSupport`ì„ ë¶™ì—¬ì£¼ê¸°
- ì¢…ë¥˜
    - DomainClassConverter
        - MVC request parameterë‚˜ path variableë¡œë¶€í„° Spring Data Repositoryê°€ ê´€ë¦¬í•˜ëŠ” ë„ë©”ì¸ í´ë˜ìŠ¤ë¡œì˜ conversionì„ ì œê³µ
        - Entityê°€ Controllerì— ê·¸ëŒ€ë¡œ ë…¸ì¶œë˜ê¸° ë•Œë¬¸ì— ì‚¬ìš©ì„ ì§€ì–‘
    - HandlerMethodArgumentResolver
        - MVC request parameterë¥¼ Pageable, Sort ì¸ìŠ¤í„´ìŠ¤ë¡œ resolverí•  ìˆ˜ ìˆë„ë¡ í•´ì¤Œ

<br/>

**Pageable**
- pagination ì •ë³´ë¥¼ ì¶”ìƒí™”í•œ ì¸í„°í˜ì´ìŠ¤
```java
public interface Pageable {
  int getPageNumber();
  int getPageSize();
  int getOffset();

  Sort getSort();

  Pageable next();
  Pageable previousOrFirst();
  Pageable first();

  boolean hasPrevious();
}
```

<br/>

**Pageable ì˜ˆì‹œ**
- Controller
```java
@GetMapping("/members")
public List<MemberNameOnly> getMembers(Pageable pageable) {
    return memberRepository.getAllBy(pageable).getContent();
}
```
- Repository
```java
Page<MemberNameOnly> getAllBy(Pageable pageable);
```

<br/>

**Open EntityManager In View**
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë²—ì–´ë‚˜ì„œ Lazy Loading ì‹œë„ì‹œ `LazyInitializationException` ë°œìƒ
- OSIV ì ìš©í•´ì„œ í•´ê²° ê°€ëŠ¥
    - ì¸í„°ì…‰í„°
    - í•„í„°

<Br/>

**Querydsl**
- ì •ì  íƒ€ì…ì„ ì´ìš©í•´ì„œ JPQLì„ ì½”ë“œë¡œ ì‘ì„±í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” í”„ë ˆì„ì›Œí¬
- Typeì´ Safeí•œ ì¥ì 

<Br/>

**ì‚¬ìš© ì˜ˆì‹œ**
- *ê¸°ë³¸ ì„¤ì •*
    - Project Structure -> Modules -> target/generated-source/annotaionsë¥¼ Excluded í•´ì œ

1. interface `~~RepositoryCustom` ìƒì„±
1. `@NoRepositoryBean` ì–´ë…¸í…Œì´ì…˜ ë¶™ì—¬ì£¼ê¸°
1. class `~~RepositoryImpl` ìƒì„±
    - `Impl` suffixëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì§€ì •ëœ ê°’
    - `QuerydslRepositorySupport`ì„ í™•ì¥ & `~~RepositoryCustom` ìƒì†
1. QTypeì˜ ê°ì²´ë¡œ ì¿¼ë¦¬ ì‘ì„±
1. `~~Repository`ì— `~~RepositoryCustom`ì„ ì¶”ê°€ë¡œ í™•ì¥

<br/>

- ItemRepositoryCustom  
```java
@NoRepositoryBean
public interface ItemRepositoryCustom {
    List<Item> getItemsAfterOrderDate(LocalDateTime orderDate);
}
```
- ItemRepositoryImpl
```java
public class ItemRepositoryImpl extends QuerydslRepositorySupport implements ItemRepositoryCustom {
    public ItemRepositoryImpl() {
        super(Item.class);
    }

    @Override
    public List<Item> getItemsAfterOrderDate(LocalDateTime orderDate) {
        QItem item = QItem.item;
        QOrderItem orderItem = QOrderItem.orderItem;
        QOrder order = QOrder.order;

        Date baseDate = Date.from(orderDate.toInstant(ZoneOffset.of("+09:00")));

        return from(item)
            .leftJoin(item.orderItems, orderItem)
            .innerJoin(orderItem.order, order)
            .where(order.orderDate.after(baseDate))
            .select(item)
            .fetch();
    }

}
```

- ItemRepository
```java
public interface ItemRepository extends JpaRepository<Item, Long>, ItemRepositoryCustom {
}
```

<Br/>

**N + 1 ë¬¸ì œ**
- ë‹¨ì¼ Entity ì¡°íšŒ ì‹œ ì¿¼ë¦¬
```sql
select
    item0_."item_id" as item_id1_4_0_,
    item0_."item_name" as item_nam2_4_0_,
    item0_."price" as price3_4_0_ 
from
    "Items" item0_ 
where
    item0_."item_id"=1
```

- ì—¬ëŸ¬ Entity ì¡°íšŒ ì‹œ ì¿¼ë¦¬
```sql
select
    item0_."item_id" as item_id1_4_,
    item0_."item_name" as item_nam2_4_,
    item0_."price" as price3_4_ 
from
    "Items" item0_
```

- ì—¬ëŸ¬ Entity ì¡°íšŒ & ê°ì²´ ê·¸ë˜í”„ íƒìƒ‰
```sql
select
    item0_."item_id" as item_id1_4_,
    item0_."item_name" as item_nam2_4_,
    item0_."price" as price3_4_ 
from
    "Items" item0_
select
    orderitems0_."item_id" as item_id4_8_0_,
    orderitems0_."line_number" as line_num1_8_0_,
    orderitems0_."order_id" as order_id2_8_0_,
    orderitems0_."line_number" as line_num1_8_1_,
    orderitems0_."order_id" as order_id2_8_1_,
    orderitems0_."item_id" as item_id4_8_1_,
    orderitems0_."quantity" as quantity3_8_1_,
    order1_."order_id" as order_id1_9_2_,
    order1_."order_date" as order_da2_9_2_ 
from
    "OrderItems" orderitems0_ 
inner join
    "Orders" order1_ 
        on orderitems0_."order_id"=order1_."order_id" 
where
    orderitems0_."item_id"=1
select
    orderitems0_."item_id" as item_id4_8_0_,
    orderitems0_."line_number" as line_num1_8_0_,
    orderitems0_."order_id" as order_id2_8_0_,
    orderitems0_."line_number" as line_num1_8_1_,
    orderitems0_."order_id" as order_id2_8_1_,
    orderitems0_."item_id" as item_id4_8_1_,
    orderitems0_."quantity" as quantity3_8_1_,
    order1_."order_id" as order_id1_9_2_,
    order1_."order_date" as order_da2_9_2_ 
from
    "OrderItems" orderitems0_ 
inner join
    "Orders" order1_ 
        on orderitems0_."order_id"=order1_."order_id" 
where
    orderitems0_."item_id"=2

...
```

**N + 1 ë¬¸ì œ**
- ì—°ê´€ ê´€ê³„ Entityë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ì¿¼ë¦¬ë¥¼ Në²ˆ ì¶”ê°€ ìˆ˜í–‰í•˜ëŠ” ë¬¸ì œ
- í•´ê²°
    - Fetch Join
    - Entity Graph

<Br/>

**ì£¼ì˜í•  ì **
- Paginatino + Fetch Joinì€ <span style="color : red"> ì ˆëŒ€ ê¸ˆë¬¼</sapn>
- ëª¨ë“  ë ˆì½”ë“œë¥¼ ê°€ì ¸ì›ŒëŠ” ì¿¼ë¦¬ê°€ ì‹¤í–‰ ë¨
- *ì‹¤ë¬´ì—ì„œ ì´ëŸ° ê²½ìš°*
    - ì²˜ìŒ IDê°’ë§Œ ê°€ì ¸ì™€ì„œ ê·¸ ì•„ì´ë””ë¥¼ ê°€ì§€ê³  Fetch Joinì„ ì‹œí‚´

<br/>

**MultipleBagFetchException**
- ë‘˜ ì´ìƒì˜ ì»¬ë ‰ì…˜ì„ Fetch Joinì‹œ ë°œìƒ
- Javaì˜ ListëŠ” Hibernateì˜ Bag íƒ€ì…ìœ¼ë¡œ ë§µí•‘
    - ì¤‘ë³µì„ í—ˆìš©í•˜ê³  ë¹„ìˆœì°¨ì  ì»¬ë ˆì…˜
- ê²°ê³¼ê°€ ì¹´í…Œì‹œì•ˆ ê³±ì—ì„œ ì–´ëŠ í–‰ì´ ìœ íš¨ì¸ì§€ ê·¸ë ‡ì§€ ì•Šì€ì§€ íŒë‹¨ ë¶ˆê°€
- Listë¥¼ Setìœ¼ë¡œ ë³€ê²½

<br/>

**Entity Graph**
- Entityë¥¼ ì¡°íšŒí•˜ëŠ” ì‹œì ì— ì—°ê´€ Entityë“¤ì„ í•¨ê»˜ ì¡°íšŒí•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê¸°ëŠ¥
- ì¢…ë¥˜
    - `@NamedEntityGraph`
    - `EntityManager.createEntityGraph()`

<br/>

---

### ê³¼ì œ
**[ì§€ë‚œ ê³¼ì œ](https://github.com/unhas01/nhnacademy/tree/master/Week13/board)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì§„í–‰**
- Repository ê¸°ëŠ¥ ê°•í™”
    - `@Query`ë¥¼ ì´ìš©í•´ JPQL ì¿¼ë¦¬ ì‹¤í–‰
    - Querydsl ì‚¬ìš©
- Web Support ì ìš©
- DTO Projectionì„ í†µí•´ DTO ë°˜í™˜
- `Pageable`ì„ ì´ìš©í•´ Paginatino ì ìš©

<br/>

**ì½”ë“œ**
- [ë§í¬ ğŸ”‘](https://github.com/unhas01/nhnacademy/tree/master/Week14/jpa-day3)





