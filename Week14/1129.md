# 1129 ì •ë¦¬

### JPA 2ì¼ì°¨

---

### ì—°ê´€ê´€ê³„ ë§µí•‘
**ë°ì´í„°ë² ì´ìŠ¤ ì •ê·œí™”**
- ì •ê·œí™”ëŠ” ì¤‘ë³µ ë°ì´í„°ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ë°ì´í„° ë¶ˆì¼ì¹˜ í˜„ìƒì„ í•´ì†Œí•˜ëŠ” ê³¼ì •
- í…Œì´ë¸”ì€ ì¤‘ë³µë˜ì§€ ì•Šì€ ë°ì´í„°ë¥¼ ê°€ì§
- ì—¬ëŸ¬ í…Œì´ë¸”ë“¤ì˜ ê´€ê³„ëŠ” ê´€ê³„ë¥¼ ë§ºì–´ JOINì„ ì´ìš©í•´ì„œ ê´€ê³„ í…Œì´ë¸”ì„ ì°¸ì¡°

<br/>

**ì—°ê´€ê´€ê³„**
- ì™¸ë˜í‚¤(FK) ë§µí•‘
    - `@JoinColumn` : ì™¸ë˜í‚¤ ë§µí•‘
    - `@JoinColumns` : ë³µí•© ì™¸ë˜í‚¤ ë§µí•‘

<br/>

**ì˜ˆì‹œ**
- ERD

<img width="1160" alt="image" src="https://user-images.githubusercontent.com/87689191/204487279-1de01070-64c8-4866-9717-2c4465a62bdf.png">

- Entity
```java
@Entity
@Table(name="Members")
public class Member {
    @Id
    @Column(name = "member_id")
    private String id;

    @Column(name = "user_name")
    private String userName;

    @ManyToOne(fetch = FetchType.EAGER, cascade = CascadeType.ALL)
    @JoinColumn(name = "team_id")
    private Team team;
}
```

<br/>

**ë‹¤ì¤‘ì„±**
- `@OneToOne`
- `@OneToMany`
- `@ManyToOne`
- ~~`@ManyToMany`~~
    - ë‹¤ëŒ€ë‹¤ëŠ” ë³µì¡í•´ì§€ê¸° ë•Œë¬¸ì— ì‚¬ìš©ì„ í•˜ì§€ ë§ê¸°

<br/>

**Fetch ì „ëµ**
- JPAê°€ í•˜ë‚˜ì˜ Entityë¥¼ ê°€ì ¸ì˜¬ ë•Œ ì—°ê´€ê´€ê³„ê°€ ìˆëŠ” Entityë“¤ì„ ì–´ë–»ê²Œ ê°€ì ¸ì˜¬ ê²ƒì¸ì§€ì— ëŒ€í•œ ì„¤ì •
- FetchType.EAGER (ì¦‰ì‹œ ë¡œë”©)
- FetchType.LAZY (ì§€ì—° ë¡œë”©)
- ë‹¤ì¤‘ì„±ê³¼ ê¸°ë³¸ Fetch ì „ëµ
    - ~ToOne : FetchType.EAGER
    - ~ToMany : FetchType.LAZY

<br/>

**ì˜ì†ì„± ì „ì´(cascade)**
- Entity ì˜ì†ì„± ìƒíƒœ ë³€í™”ë¥¼ ì—°ê´€ëœ Entityì—ë„ í•¨ê»˜ ì ìš©
- ë‹¤ì¤‘ì„± ì§€ì •ì‹œ cascade ì†ì„±ìœ¼ë¡œ ì„¤ì •
- ì¢…ë¥˜
    - ALL
    - PERSIST
    - MERGE
    - REMOVE
    - REFRESH
    - DETACH

<br/>

**ì—°ê´€ê´€ê³„ì˜ ë°©í–¥ì„±**
- ë‹¨ë°©í–¥
- ì–‘ë°©í–¥

<br/>

**ì–‘ë°©í–¥ ì—°ê´€ ê´€ê³„**
- ê´€ê³„ì˜ ì£¼ì¸
    - ì™¸ë˜í‚¤ë¥¼ ê°€ì§€ê³  ìˆëŠ” ê³³
        - `@JoinColumn`ì„ ì„ ì–¸
    - ì™¸ë˜í‚¤ë¥¼ ê°€ì§€ê³  ìˆì§€ ì•ŠëŠ” ê³³
        - `mappedBy = "~~~"`ì†ì„±ìœ¼ë¡œ ì„ ì–¸

<br/>

**ì˜ˆì‹œ**

- Member Entity
```java
@Entity
@Table(name="Members")
public class Member {
    @Id
    @Column(name = "member_id")
    private String id;

    @Column(name = "user_name")
    private String userName;

    @ManyToOne(fetch = FetchType.EAGER, cascade = CascadeType.ALL)
    @JoinColumn(name = "team_id")
    private Team team;
}
```

- Team Entity
```java
@Entity
@Table(name = "Teams")
public class Team {
    @Id
    @Column(name = "team_id")
    private String id;

    @Column(name = "team_name")
    private String name;

    @OneToMany(mappedBy = "team", fetch = FetchType.EAGER)
    private List<Member> members;
}
```

<br/>

**ë‹¨ë°©í–¥ vs ì–‘ë°©í–¥**
- ë‹¨ë°©í–¥ ë§µí•‘ë§Œìœ¼ë¡œ ì—°ê´€ê´€ê³„ ë§µí•‘ì€ ì´ë¯¸ ì™„ë£Œ
- ì–‘ë°©í–¥
    - ì¢€ ë” ë³µì¡
    - ê°ì²´ì—ì„œ ì–‘ìª½ ë°©í–¥ì„ ëª¨ë‘ ê´€ë¦¬í•´ì•¼ í•¨
    - ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ ê°ì²´ ê·¸ë˜í”„ íƒìƒ‰ ê°€ëŠ¥

<Br/>

**ë‹¨ë°©í–¥ ì¼ëŒ€ì¼(1:1) ê´€ê³„**
- ì£¼ í…Œì´ë¸”ì— ì™¸ë˜ í‚¤(FK)ê°€ ìˆëŠ” ê²½ìš°
- ì™¸ë˜ í‚¤ë¥¼ ê°€ì§„ìª½ì— `@JoinColumn` ì„ ì–¸

<details>
    <summary> ë‹¨ë°©í–¥ ì¼ëŒ€ì¼ ê´€ê³„ </summary>

<img width="985" alt="image" src="https://user-images.githubusercontent.com/87689191/204492574-8a0a3f25-71cc-4e70-b33b-73bcf80806a9.png">

- Member
```java
@Getter
@Setter
@Entity
@Table(name = "Members")
public class Member {
    @Id
    @Column(name = "member_id")
    private String id;

    @Column(name = "user_name")
    private String userName;

    @OneToOne
    @JoinColumn(name = "locker_id")
    private Locker locker;

}
```

- Locker
```java
@Getter
@Setter
@Entity
@Table(name = "Lockers")
public class Locker {
    @Id
    @Column(name = "locker_id")
    private Long id;

    @Column(name = "locker_name")
    private String name;

}
```

- Test
```java
@ExtendWith(SpringExtension.class)
@WebAppConfiguration
@Transactional
@ContextHierarchy({
    @ContextConfiguration(classes = RootConfig.class),
    @ContextConfiguration(classes = WebConfig.class)
})
public class OneToOneTest {
    @PersistenceContext
    EntityManager entityManager;

    @Test
    void test() {
        Locker locker = new Locker();
        locker.setId(1L);
        locker.setName("No.1 Locker");

        entityManager.persist(locker);

        Member member = new Member();
        member.setId("nhn");
        member.setUserName("academy");
        member.setLocker(locker);

        entityManager.persist(member);

        entityManager.flush();
    }

}
```

</details>


<br/>
<br/>

**ì–‘ë°©í–¥ ì¼ëŒ€ì¼(1:1) ê´€ê³„**
- ì–‘ìª½ ëª¨ë‘ `@JoinColumn` ì„ ì–¸
- Test Codeë¥¼ ë³´ë©´ `persist()` í›„ ì–‘ ìª½ ê°ì²´ì— ê°’ì„ ì €ì¥í•´ì¤Œ (`set()`)
    - null ê°’ì„ ë§‰ê¸° ìœ„í•´ ë°˜ë“œì‹œ í•´ì¤˜ì•¼í•˜ëŠ” ì‘ì—…

<details>
    <summary> ì–‘ë°©í–¥ ì¼ëŒ€ì¼ ê´€ê³„ </summary>

- Member
```java
@Getter
@Setter
@Entity
@Table(name = "Members")
public class Member {
    @Id
    @Column(name = "member_id")
    private String id;

    @Column(name = "user_name")
    private String userName;

    @OneToOne(mappedBy = "member")
    private Locker locker;

}
```

- Locker
```java
@Getter
@Setter
@Entity
@Table(name = "Lockers")
public class Locker {
    @Id
    @Column(name = "locker_id")
    private Long id;

    @Column(name = "locker_name")
    private String name;

    @OneToOne
    @JoinColumn(name = "member_id")
    private Member member;

}
```

- Test Code
    - `member.setLocker(locker);`ì„ í†µí•´ ì–‘ìª½ëª¨ë‘ ê°ì²´ ê°’ì„ ê°€ì§
```java
@ExtendWith(SpringExtension.class)
@WebAppConfiguration
@Transactional
@ContextHierarchy({
    @ContextConfiguration(classes = RootConfig.class),
    @ContextConfiguration(classes = WebConfig.class)
})
public class OneToOneTest {
    @PersistenceContext
    EntityManager entityManager;

    @Test
    void test() {
        Member member = new Member();
        member.setId("nhn");
        member.setUserName("academy");

        entityManager.persist(member);

        Locker locker = new Locker();
        locker.setId(1L);
        locker.setName("No.1 Locker");
        locker.setMember(member);

        entityManager.persist(locker);

        member.setLocker(locker);

        assertThat(member.getLocker().getName()).isEqualTo("No.1 Locker");

        entityManager.flush();
    }

}
```

</details>

<br/>
<br/>

**ì¼ëŒ€ì¼(1:1) ì‹ë³„ ê´€ê³„**
- ì‹ë³„ ê´€ê³„ : ì™¸ë˜ í‚¤ì´ê¸°ë„ í•˜ê³  PKì´ê¸°ë„ í•œ ê´€ê³„ë¥¼ ê°€ì§„ í…Œì´ë¸”ë“¤
- ì™¸ë˜ í‚¤ë¥¼ ê°€ì§„ìª½ì—ì„œ `@JoinColumn` ì„ ì–¸
- `@MapsId` : ì™¸ë˜ í‚¤ì´ì PKì„ì„ ëª…ì‹œ
    - Test Codeì—ì„œ `boardDetail.setBoardId()` í•´ì£¼ì§€ ì•Šì•„ë„ ìë™ìœ¼ë¡œ ë§µí•‘

<details>
    <summary> ì¼ëŒ€ì¼ ì‹ë³„ ê´€ê³„ </summary>

<img width="982" alt="image" src="https://user-images.githubusercontent.com/87689191/204502175-7ad71c18-096f-4336-81c4-6371a7f37af8.png">

- Board
```java
@Getter
@Setter
@Entity
@Table(name = "Boards")
public class Board {
    @Id
    @Column(name = "board_id")
    private Long id;

    private String title;

}
```

- BoardDetail
```java
@Getter
@Setter
@Entity
@Table(name = "BoardDetails")
public class BoardDetail {
    @Id
    private Long boardId;

    @MapsId
    @OneToOne
    @JoinColumn(name = "board_id")
    private Board board;

    private String content;

}
```

- Test Code
```java
@ExtendWith(SpringExtension.class)
@WebAppConfiguration
@Transactional
@ContextHierarchy({
    @ContextConfiguration(classes = RootConfig.class),
    @ContextConfiguration(classes = WebConfig.class)
})
public class OneToOneTest {
    @PersistenceContext
    EntityManager entityManager;

    @Test
    void test2() {
        Board board = new Board();
        board.setId(1L);
        board.setTitle("ê²Œì‹œë¬¼ ì œëª©");

        entityManager.persist(board);

        BoardDetail boardDetail = new BoardDetail();
        boardDetail.setBoard(board);
        boardDetail.setContent("ë‚´ìš© ë‚´ìš© ë‚´ìš©");

        entityManager.persist(boardDetail);

        entityManager.flush();
    }

}
```

</details>

<br/>
<br/>

**ë‹¨ë°©í–¥ ë‹¤ëŒ€ì¼(N:1) ê´€ê³„**

<details>
    <summary> ë‹¨ë°©í–¥ ë‹¤ëŒ€ì¼ ê´€ê³„ </summary>

<img width="974" alt="image" src="https://user-images.githubusercontent.com/87689191/204504708-94c12ec0-db3e-441b-9f29-84b7c77f82dd.png">

- Member
```java
@Getter
@Setter
@Entity
@Table(name = "Members")
public class Member {
    @Id
    @Column(name = "member_id")
    private String id;

    @Column(name = "user_name")
    private String userName;
}
```

- MemberDetail
```java
@Getter
@Setter
@Entity
@Table(name = "MemberDetails")
public class MemberDetail {
    @Id
    @Column(name = "member_detail_id")
    private Long id;

    private String type;

    private String description;

    @ManyToOne
    @JoinColumn(name = "member_id")
    private Member member;

}
```

- Test Code
```java
@ExtendWith(SpringExtension.class)
@WebAppConfiguration
@Transactional
@ContextHierarchy({
    @ContextConfiguration(classes = RootConfig.class),
    @ContextConfiguration(classes = WebConfig.class)
})
public class ManyToOneTest {
    @PersistenceContext
    EntityManager entityManager;

    @Test
    void test() {
        Member member = new Member();
        member.setId("nhn");
        member.setUserName("academy");

        entityManager.persist(member);

        MemberDetail memberDetail1 = new MemberDetail();
        memberDetail1.setId(1L);
        memberDetail1.setType("type1");
        memberDetail1.setDescription("...");
        memberDetail1.setMember(member);

        entityManager.persist(memberDetail1);

        MemberDetail memberDetail2 = new MemberDetail();
        memberDetail2.setId(2L);
        memberDetail2.setType("type2");
        memberDetail2.setDescription("ì„¤ëª… ì„¤ëª…");
        memberDetail2.setMember(member);

        entityManager.persist(memberDetail2);

        entityManager.flush();
    }
}
```

</details>

<details>
    <summary> ë‹¨ë°©í–¥ ë‹¤ëŒ€ì¼ ê´€ê³„(cascade) </summary>

- `@ManyToOne(cascade = CascadeType.PERSIST)` ì ìš©
- Entityê°€ ë³€í•˜ë©´ ìë™ìœ¼ë¡œ ì—°ê´€ê´€ê³„ì¸ Entityë„ persist í•´ì¤Œ

- Member ë™ì¼
- MeberDetail
```java
@Getter
@Setter
@Entity
@Table(name = "MemberDetails")
public class MemberDetail {
    @Id
    @Column(name = "member_detail_id")
    private Long id;

    private String type;

    private String description;

    @ManyToOne(cascade = CascadeType.PERSIST)
    @JoinColumn(name = "member_id")
    private Member member;

}
```
- Test Code
```java
@ExtendWith(SpringExtension.class)
@WebAppConfiguration
@Transactional
@ContextHierarchy({
    @ContextConfiguration(classes = RootConfig.class),
    @ContextConfiguration(classes = WebConfig.class)
})
public class ManyToOneTest {
    @PersistenceContext
    EntityManager entityManager;

    @Test
    void test() {
        Member member = new Member();
        member.setId("nhn");
        member.setUserName("academy");

        MemberDetail memberDetail1 = new MemberDetail();
        memberDetail1.setId(1L);
        memberDetail1.setType("type1");
        memberDetail1.setDescription("...");
        memberDetail1.setMember(member);

        entityManager.persist(memberDetail1);

        MemberDetail memberDetail2 = new MemberDetail();
        memberDetail2.setId(2L);
        memberDetail2.setType("type2");
        memberDetail2.setDescription("ì„¤ëª… ì„¤ëª…");
        memberDetail2.setMember(member);

        entityManager.persist(memberDetail2);

        entityManager.flush();
    }
}
```

</details>


<br/>
<br/>

**ë‹¨ë°©í–¥ ì¼ëŒ€ë‹¤(1:N) ê´€ê³„**
- ë‹¨ì  : ë‹¤ë¥¸ í…Œì´ë¸”ì— ì™¸ë˜ í‚¤ê°€ ìˆìœ¼ë©´ ì—°ê´€ê´€ê³„ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì¶”ê°€ì ì¸ UPDATE ì¿¼ë¦¬ ì‹¤í–‰
<details>
    <summary> ë‹¨ë°©í–¥ ì¼ëŒ€ë‹¤ ê´€ê³„ </summary>

- Member
```java
@Getter
@Setter
@Entity
@Table(name = "Members")
public class Member {
    @Id
    @Column(name = "member_id")
    private String id;

    @Column(name = "user_name")
    private String userName;

    @OneToOne(mappedBy = "member")
    private Locker locker;

    @OneToMany
    @JoinColumn(name = "member_id")
    private List<MemberDetail> memberDetails;

}
```

- MemberDetail
```java
@Getter
@Setter
@Entity
@Table(name = "MemberDetails")
public class MemberDetail {
    @Id
    @Column(name = "member_detail_id")
    private Long id;

    private String type;

    private String description;
}
```

- Test Code
```java
@ExtendWith(SpringExtension.class)
@WebAppConfiguration
@Transactional
@ContextHierarchy({
    @ContextConfiguration(classes = RootConfig.class),
    @ContextConfiguration(classes = WebConfig.class)
})
public class OneToManyTest {
    @PersistenceContext
    EntityManager entityManager;

    @Test
    void test() {
        MemberDetail memberDetail1 = new MemberDetail();
        memberDetail1.setId(1L);
        memberDetail1.setType("type1");
        memberDetail1.setDescription("...");

        entityManager.persist(memberDetail1);

        MemberDetail memberDetail2 = new MemberDetail();
        memberDetail2.setId(2L);
        memberDetail2.setType("type2");
        memberDetail2.setDescription("ì„¤ëª… ì„¤ëª…");

        entityManager.persist(memberDetail2);

        List<MemberDetail> memberDetails = new ArrayList<>();
        memberDetails.add(memberDetail1);
        memberDetails.add(memberDetail2);

        Member member = new Member();
        member.setId("nhn");
        member.setUserName("academy");
        member.setMemberDetails(memberDetails);

        entityManager.persist(member);

        entityManager.flush();
    }

}
```
</details>

<br/>
<br/>

**ì–‘ë°©í–¥ ì¼ëŒ€ë‹¤(1:N) ê´€ê²Œ**
- ë‹¨ë°©í–¥ ì¼ëŒ€ë‹¤ ê´€ê³„ì—ì„œì˜ update ì¿¼ë¦¬ê°€ ë§¤ë²ˆ ë‚˜ê°€ëŠ” ë¬¸ì œë¥¼ í•´ê²° ê°€ëŠ¥
- ì™¸ë˜ í‚¤ë¥¼ ê°€ì§„ ìª½ì€ `@JoinColumn()` ì„ ì–¸
- ë°˜ëŒ€ ìª½ì€ `mappedBy = ""`ì„ ì–¸
<details>
    <summary> ì–‘ë°©í–¥ ì¼ëŒ€ë‹¤ ê´€ê³„(cascade) </summary>

- Member
```java
@Getter
@Setter
@Entity
@Table(name = "Members")
public class Member {
    @Id
    @Column(name = "member_id")
    private String id;

    @Column(name = "user_name")
    private String userName;

    @OneToOne(mappedBy = "member")
    private Locker locker;

    @OneToMany(mappedBy = "member", cascade = CascadeType.PERSIST)
    private List<MemberDetail> memberDetails;

}
```

- MemberDetail
```java
@Getter
@Setter
@Entity
@Table(name = "MemberDetails")
public class MemberDetail {
    @Id
    @Column(name = "member_detail_id")
    private Long id;

    private String type;

    private String description;

    @ManyToOne
    @JoinColumn(name = "member_id")
    private Member member;

}
```

- Test Code
```java
@ExtendWith(SpringExtension.class)
@WebAppConfiguration
@Transactional
@ContextHierarchy({
    @ContextConfiguration(classes = RootConfig.class),
    @ContextConfiguration(classes = WebConfig.class)
})
public class OneToManyTest {
    @PersistenceContext
    EntityManager entityManager;

    @Test
    void test() {
        Member member = new Member();
        member.setId("nhn");
        member.setUserName("academy");

        MemberDetail memberDetail1 = new MemberDetail();
        memberDetail1.setId(1L);
        memberDetail1.setType("type1");
        memberDetail1.setDescription("...");
        memberDetail1.setMember(member);

        MemberDetail memberDetail2 = new MemberDetail();
        memberDetail2.setId(2L);
        memberDetail2.setType("type2");
        memberDetail2.setDescription("ì„¤ëª… ì„¤ëª…");
        memberDetail2.setMember(member);

        List<MemberDetail> memberDetails = new ArrayList<>();
        memberDetails.add(memberDetail1);
        memberDetails.add(memberDetail2);

        member.setMemberDetails(memberDetails);

        entityManager.persist(member);

        entityManager.flush();
    }

}
```

</details>

<br/>

**ì‹¤ìŠµ**
- ë§µí•‘í•´ë³´ê¸°
<img width="567" alt="image" src="https://user-images.githubusercontent.com/87689191/204512500-abe6e087-279e-4ad4-a5d2-ce2334bab43f.png">

<details>
    <summary> ë§µí•‘ ì‹¤ìŠµ </summary>

- Item
```java
@NoArgsConstructor
@Getter
@Setter
@Entity
@Table(name = "Items")
public class Item {
    @Id
    @Column(name = "item_id")
    private Long itemId;

    @Column(name = "item_name")
    private String itemName;

    private Long price;

    @OneToMany(mappedBy = "item")
    private List<OrderItem> orderItems;

}
```

- Order
```java
@NoArgsConstructor
@Getter
@Setter
@Entity
@Table(name = "Orders")
public class Order {
    @Id
    @Column(name = "order_id")
    private Long orderId;

    @Temporal(TemporalType.TIMESTAMP)
    @Column(name = "order_date")
    private Date orderDate;

}
```

- OrderItem
```java
@NoArgsConstructor
@Getter
@Setter
@Entity
@Table(name = "OrderItems")
public class OrderItem {
    @EmbeddedId
    private Pk pk;

    @ManyToOne
    @JoinColumn(name = "item_id")
    private Item item;

    private Integer quantity;

    // TODO #1: ë‹¤ëŒ€ì¼ ì‹ë³„ ê´€ê³„ì´ë¯€ë¡œ `@MapsId`ë¥¼ ì‚¬ìš©
    @MapsId("orderId")
    @ManyToOne
    @JoinColumn(name = "order_id")
    private Order order;


    @NoArgsConstructor
    @AllArgsConstructor
    @EqualsAndHashCode
    @Getter
    @Setter
    @Embeddable
    public static class Pk implements Serializable {
        @Column(name = "order_id")
        private Long orderId;

        @Column(name = "line_number")
        private Integer lineNumber;
    }

}
```

</details>

---

### ê³¼ì œ
**ì „ë‚  Entity ë§µí•‘ ì´ìš©**
- Relation ì„¤ì •
- JpaRepositoryë¥¼ êµ¬í˜„
- ë©”ì„œë“œëª… ê·œì¹™ì— ë”°ë¼ ë©”ì„œë“œ ì´ë¦„ ì§“ê¸°
- ~~í…ŒìŠ¤íŠ¸ì½”ë“œ~~
    - ì„¤ì •ë¬¸ì œë¡œ ì‹¤íŒ¨
- ì½”ë“œ :
    - [Repository ë§í¬ ğŸ”‘](https://github.com/unhas01/nhnacademy/tree/master/Week14/repository)
    - [Entity ë§í¬ ğŸ”‘](https://github.com/unhas01/nhnacademy/tree/master/Week14/entity-relation)

