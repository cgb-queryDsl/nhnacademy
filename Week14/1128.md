# 1128 ì •ë¦¬

### JPA 1ì¼ì°¨

---

**ê°ì²´ì§€í–¥**
- Javaì–¸ì–´ëŠ” ê°ì²´ì§€í–¥
- MySQL, Oracle ë“±ë“±ì˜ SQLë¬¸ì€ ê°ì²´ì§€í–¥ì´ë¼ í•  ìˆ˜ ìˆë‚˜..?
    - DB í…Œì´ë¸”ì— í•„ë“œê°€ í•˜ë‚˜ë§Œ ì¶”ê°€ë˜ì–´ë„ ëª¨ë“  SQLë¬¸ì„ ìˆ˜ì •í•´ì•¼ í•˜ëŠ” ì¼ì´ ìƒê¹€
- íŒ¨ëŸ¬ë‹¤ì„ì˜ ë¶ˆì¼ì¹˜ ë°œìƒ    
    - RDBMS $\neq$ ê°ì²´ì§€í–¥
- `JPA`ì˜ ë“±ì¥ ì´ìœ 

<br/>

**ì‹¤ìŠµ**
- ì‹¤ìŠµ íŒŒì¼ ì£¼ì†Œ : https://github.com/dongmyo/academy-spring-jpa

<br/>

**DB**
- H2 database ì‚¬ìš©
- ë‹¤ìš´ : https://www.h2database.com/html/main.html
- ì‹¤í–‰ ëª…ë ¹ì–´
```
$ java - jar h2-2.1.212.jar
```

<br/>

**ORM**
- Object-Relational Mapping
- ORM í”„ë ˆì„ì›Œí¬ê°€ ì¤‘ê°„ì—ì„œ ê°ì²´ì™€ ê´€ê±”í˜• ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë§¤í•‘

<br/>

**JPA**
- Jakarta Persistence API
- ì‹¤ì œ êµ¬í˜„ : Hibernate
- JPAë¥¼ ì‚¬ìš©í•´ì•¼í•  ì´ìœ 
    - SQL ì¤‘ì‹¬ ê°œë°œ -> ê°ì²´ ì¤‘ì‹¬ ê°œë°œ
    - íŒ¨ëŸ¬ë‹¤ì„ ë¶ˆì¼ì¹˜ í•´ê²°
        - íŒ¨ëŸ¬ë‹¤ì„ ë¶ˆì¼ì¹˜ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ë¬¸ì œ (ìƒì†, ì—°ê´€ê´€ê³„, ê°ì²´ ê·¸ë˜í”„ íƒìƒ ë“±) í•´ê²°
    - ìƒì‚°ì„±
        - ë°˜ë³µì ì¸ CRUDë¥¼ ê°œë°œìê°€ ì§ì ‘ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ë¨
    - Maintenance
        - ì»¬ëŸ¼ ì¶”ê°€/ì‚­ì œì‹œ CRUDë¥¼ JPAê°€ ê´€ë¦¬í•˜ëŠ” ëª¨ë¸ë§Œ ìˆ˜ì •í•˜ë©´ ë¨
    - ë°ì´í„° ì ‘ê·¼ ì¶”ìƒí™”ì™€ ë²¤ë” ë…ë¦½ì„±
    

<br/>


**Spring Data**
- ë‹¤ì–‘í•œ ë°ì´í„° ì €ì¥ì†Œì— ëŒ€í•œ ì ‘ê·¼ì„ ì¶”ìƒí™”í•˜ê¸° ìœ„í•œ Spring í”„ë¡œì íŠ¸
- JPA, JDBC, ElasticSearch ë“±

<br/>

**Spring Data JPA**
- repository ì¶”ìƒí™”ë¥¼ í†µí•´ interface ì„ ì–¸ë§Œìœ¼ë¡œ êµ¬í˜„ ê°€ëŠ¥
- ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±

<Br/>

**Spring + JPA**
- `pom.xml` ì„¸íŒ…
```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.data</groupId>
            <artifactId>spring-data-bom</artifactId>
            <version>2021.2.0</version>
            <scope>import</scope>
            <type>pom</type>
        </dependency>
    </dependencies>
</dependencyManagement>

<dependency>
    <groupId>org.springframework.data</groupId>
    <artifactId>spring-data-jpa</artifactId>
</dependency>
```
- `JpaConfig` ì„¸íŒ…
```java
@EnableJpaRepositories(basePackageClasses = RepositoryBase.class)
@Configuration
public class JpaConfig {
    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactory(DataSource dataSource) {
        LocalContainerEntityManagerFactoryBean emf = new LocalContainerEntityManagerFactoryBean();
        emf.setDataSource(dataSource);
        emf.setPackagesToScan("com.nhnacademy.springjpa.entity");
        emf.setJpaVendorAdapter(jpaVendorAdapters());
        emf.setJpaProperties(jpaProperties());

        return emf;
    }

    private JpaVendorAdapter jpaVendorAdapters() {
        HibernateJpaVendorAdapter hibernateJpaVendorAdapter = new HibernateJpaVendorAdapter();
        hibernateJpaVendorAdapter.setDatabase(Database.H2);

        return hibernateJpaVendorAdapter;
    }

    private Properties jpaProperties() {
        Properties jpaProperties = new Properties();
        jpaProperties.setProperty("hibernate.show_sql", "false");
        jpaProperties.setProperty("hibernate.format_sql", "true");
        jpaProperties.setProperty("hibernate.use_sql_comments", "true");
        jpaProperties.setProperty("hibernate.globally_quoted_identifiers", "true");
        jpaProperties.setProperty("hibernate.temp.use_jdbc_metadata_defaults", "false");

        return jpaProperties;
    }

    @Bean
    public PlatformTransactionManager transactionManager(EntityManagerFactory entityManagerFactory) {
        JpaTransactionManager transactionManager = new JpaTransactionManager();
        transactionManager.setEntityManagerFactory(entityManagerFactory);

        return transactionManager;
    }

}
```

<br/>

**Logging**
- JPA properties
    - ì¿¼ë¦¬ë¥¼ ë³´ì—¬ì£¼ëŠ” ì„¤ì •
    - ì•„ë˜ xmlì˜ Loggerì™€ ê°™ì´ ì„¤ì •í•˜ë©´ 2ë²ˆ ì¿¼ë¦¬ê°€ ë¡œê·¸ì— ë‚¨ìŒ
```properties
hibernate.show-sql=true
hibernate.format_sql=true
```

- logback logger

```xml
<logger name="org.hibernate.SQL" level="debug" additivity="false">
    <appender-ref ref="console" />
</logger>
```


<Br/>

**Entity ë§µí•‘**
- `Entity` : JPAë¥¼ ì´ìš©í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ê³¼ ë§µí•‘í•  í´ë˜ìŠ¤
- `ë§µí•‘` : ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ê³¼ ì»¬ëŸ¼, ê¸°ë³¸í‚¤, ì™œë˜í‚¤ ë“±ì„ ì„¤ì •í•˜ëŠ” ê²ƒ
- ì–´ë…¸í…Œì´ì…˜
    - `@Entity` : JPAê°€ ê´€ë¦¬í•  ê°ì²´ì„ì„ ëª…ì‹œ
    - `@Table` : ë§µí•‘í•  DB í…Œì´ë¸” ëª… ì§€ì •
    - `@Id` : ê¸°ë³¸í‚¤ ë§µí•‘
    - `@Column` : í•„ë“œì™€ ì»¬ëŸ¼ ë§µí•‘
    - `@Temporal` : ë‚ ì§œ íƒ€ì…ê³¼ ë§µí•‘
        - Java 8 ì´í›„ë¡  `LocalDateTime`ì„ ì‚¬ìš©í•˜ë©´ ë¶™ì´ì§€ ì•Šì•„ë„ ë¨
    - `@Transient` : íŠ¹ì • í•„ë“œë¥¼ ì»¬ëŸ¼ì— ë§µí•‘í•˜ì§€ ì•Šì„ ê²½ìš°ì— ì§€ì •



<Br/>

**ê¸°ë³¸ í‚¤ ì „ëµ** 
- TABLE ì „ëµ: ì±„ë²ˆ í…Œì´ë¸”ì„ ì‚¬ìš©
- SEQUENCE ì „ëµ: ë°ì´í„°ë² ì´ìŠ¤ ì‹œí€€ìŠ¤ë¥¼ ì‚¬ìš©í•´ì„œ ê¸°ë³¸ í‚¤ë¥¼ í• ë‹¹
    - ex.) Oracle
- IDENTITY ì „ëµ: ê¸°ë³¸ í‚¤ ìƒì„±ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ìœ„ì„
    - ex.) MySQL
- AUTO ì „ëµ: ì„ íƒí•œ ë°ì´í„°ë² ì´ìŠ¤ ë°©ì–¸(dialect)ì— ë”°ë¼ ê¸°ë³¸ í‚¤ ë§µí•‘ ì „ëµì„ ìë™ìœ¼ë¡œ ì„ íƒ


<br/>

**ë³µí•© í‚¤**
1. `@IdClass`
```java
@Entity
@Table(name = "OrderItems")
@IdClass(OrderItem.Pk.class)
public class OrderItem {
    @Id
    @Column(name = "order_id")
    private Long orderId;

    @Id
    @Column(name = "line_number")
    private Integer lineNumber;

    
    @NoArgsConstructor
    @AllArgsConstructor
    @EqualsAndHashCode
    public static class Pk implements Serializable {
        private Long orderId;

        private Integer lineNumber;

    }
}
```

2. `@EmbeddedId` & `@Embeddable`
    - `@EmbeddedId` - Entity í´ë˜ìŠ¤ì˜ í•„ë“œì— ì§€ì •
    - `@Embeddable` - ë³µí•© Key ì‹ë³„ì í´ë˜ìŠ¤ì— ì§€ì •
```java
@Entity
@Table(name = "OrderItems")
public class OrderItem {
    @EmbeddedId
    private Pk pk;

    @NoArgsConstructor
    @AllArgsConstructor
    @EqualsAndHashCode
    @Embeddable
    public static class Pk implements Serializable {
        @Column(name = "order_id")
        private Long orderId;

        @Column(name = "line_number")
        private Integer lineNumber;
    }
}
```

<br/>


**ë³µí•©í‚¤ ì¡°ê±´**
- public ë©”ì„œë“œ
- no-arg constructor (ì¸ì ì—†ëŠ” ìƒì„±ì) ì¡´ì¬
- serializable ìƒì†
- equals and hascode êµ¬í˜„

<br/>

**EntityManager / EntityManagerFactory**
- EntityManagerFactory
    - EntityManagerë¥¼ ìƒì„±í•˜ëŠ” íŒ©í† ë¦¬
    - ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¼ë°˜ì ìœ¼ë¡œ í•˜ë‚˜ì˜ Factoryë¥¼ ì‚¬ìš©
        - ë§Œë“œëŠ” ë¹„ìš©ì´ í¬ê¸° ë•Œë¬¸
        - Thread Safe
- EntityManager
    - Entityì˜ ì €ì¥, ìˆ˜ì •, ì‚­ì œ, ì¡°íšŒ ë“± ê´€ë ¨ëœ ëª¨ë“  ì¼ì„ ì²˜ë¦¬í•˜ëŠ” ê´€ë¦¬ì
    - ìƒì„± ë¹„ìš©ì´ í¬ì§€ ì•ŠìŒ
    - Thread Safeí•˜ì§€ ì•ŠìŒ
       - ì—¬ëŸ¬ Thread ê³µìœ í•˜ë©´ ì•ˆë¨
    - ê°ê°ì˜ ìš”ì²­ë§ˆë‹¤ ë³„ë„ì˜ Managerë¥¼ ìƒì„±í•´ì„œ ì‚¬ìš©

<Br/>

**ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸**

- Entity ìƒëª…ì£¼ê¸°
<img width="665" alt="image" src="https://user-images.githubusercontent.com/87689191/204270060-ffb31f14-a6f8-4018-84ff-e0e2a2c401cc.png">

- ë¹„ì˜ì†
    - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ì „í˜€ ê´€ê³„ê°€ ì—†ëŠ” ìƒíƒœ
- ì˜ì†
    - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ëœ ìƒíƒœ
- ì¤€ì˜ì†
    - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì—ˆë‹¤ê°€ ë¶„ë¦¬ëœ ìƒíƒœ
- ì‚­ì œ
    - ì‚­ì œëœ ìƒíƒœ

<br/>

**ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ Entityë¥¼ ê´€ë¦¬í•˜ë©´ ì–»ì„ ìˆ˜ ìˆëŠ” ì´ì **
- 1ì°¨ ìºì‹œ
- ë™ì¼ì„± ë³´ì¥
- íŠ¸ëœì­ì…˜ì„ ì§€ì›í•˜ëŠ” ì“°ê¸° ì§€ì—°
- ë³€ê²½ ê°ì§€
- ì§€ì—° ë¡œë”©

<hr/>

### ê³¼ì œ

- [ì§€ë‚œ ê³¼ì œ](https://github.com/unhas01/nhnacademy/tree/master/Week13/board)ì—ì„œ ì‚¬ìš©í–ˆë˜ DB Tableë“¤ì„ Entity ë§µí•‘í•˜ê¸°
- ë§µí•‘í•  í…Œì´ë¸”
<img width="907" alt="ERD á„‰á…®á„Œá…¥á†¼" src="https://user-images.githubusercontent.com/87689191/204270764-27e4dd23-0d58-45f1-9503-a6e38346420c.png">

- ì½”ë“œ : [ë§í¬ ğŸ”‘](https://github.com/unhas01/nhnacademy/tree/master/Week14/entity)
