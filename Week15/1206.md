# 1206 ì •ë¦¬

**Https**
- Httpsë¥¼ ì ìš©í•˜ê¸° ìœ„í•´ì„  í†±ìº£ì— https ì„¤ì •ì´ ì¶”ê°€ì ìœ¼ë¡œ í•„ìš”í•¨
- í†°ìº£ í´ë”ì— /conf/server.xmlì— ì¶”ê°€
```xml
<Server ...>
  <Service name="Catalina">
    <!-- ... -->
    
    <Connector port="8443" protocol="org.apache.coyote.http11.Http11NioProtocol"
               maxThreads="150" SSLEnabled="true">
        <SSLHostConfig>
            <Certificate certificateKeystoreFile="conf/localcert.jks" certificateKeystorePassword="chosun" />
        </SSLHostConfig>
    </Connector>
    
    <!-- ... -->
  </Service>
</Server>
```

**self-signed certificate ìƒì„±**
```
$ keytool -genkey -alias localcert -keyalg RSA -keypass chosun -storepass chosun -keystore localcert.jks
```

<Br/>

**Redis + Session**

**Redis**
- key-value êµ¬ì¡°ì˜ ë¹„ì •í˜• ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ê¸° ìœ„í•œ ì˜¤í”ˆ ì†ŒìŠ¤ ê¸°ë°˜ì˜ ë¹„ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ ì‹œìŠ¤í…œ
- ëª¨ë“  ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ë¡œ ë¶ˆëŸ¬ì™€ì„œ ì²˜ë¦¬í•˜ëŠ” ë©”ëª¨ë¦¬ ê¸°ë°˜ DBMS

<br/>

**Redis ì„¤ì¹˜**
```
$ brew install redis
```

<br/>

**ì ‘ì†**
- *nhn Academyì—ì„œ ì‚¬ìš©í•œ ê³„ì •*
```
$ redis-cli -h 133.186.151.141 -p 6379
133.186.151.141:6379> AUTH [ë¹„ë°€ë²ˆí˜¸]
OK

133.186.151.141:6379> select [DB ë²ˆí˜¸]
OK
```

<Br/>

**Method Security**
- ì„œë¹„ìŠ¤ ë ˆì´ì–´ ë©”ì„œë“œì— ë³´ì•ˆ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ëŠ” ê¸°ëŠ¥
- ì„¤ì •ë³„ë¡œ ì§€ì›í•˜ëŠ” Annotaionì— condition êµ¬ë¬¸ì„ ë§Œì¡±í•˜ë©´ í•´ë‹¹ ë©”ì„œë“œ ì‹¤í–‰ ê°€ëŠ¥
- `@EnableGlobalMethodSecurity`
    - `@PreAuthorize` & `@PostAuthorize`
    - ê°€ì¥ ê°•ë ¥í•œ ì˜µì…˜ì„ ì œê³µí•´ì„œ ìì£¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•
- ì˜ˆì‹œ
```java
// ë‹¨ìˆœ Role ì²´í¬
@PreAuthorize("hasRole('ROLE_WRITE')")
public void addBook(Book book);

// ë°˜í™˜ ê°ì²´ë¡œ ë¹„êµí•˜ëŠ” ê²ƒë„ ê°€ëŠ¥
@PostAuthorize("returnObject.writer == authentication.name")
public Book getBook(Long id);

// ì¸ìë‚˜ ì¸ìì˜ ì†ì„±ì˜ ë¹„êµí•˜ëŠ” ê²ƒë„ ê°€ëŠ¥
@PreAuthorize ("hasRole('ROLE_WRITE') && #book.writer == authentication.name")
@Transactional
public void changeBook(Book book);

// bean ìì²´ë¥¼ ì£¼ì…ë°›ëŠ” ê²ƒë„ ê°€ëŠ¥ w/SpEL
// cf.) "?." = Null safety
@PreAuthorize("@bookRepository.findOne(#id)?.writer == authentication?.name")
@Transactional
public void deleteBookById(Long id);
```

<br/>

**OAuth**
- ì¸í„°ë„· ì‚¬ìš©ìê°€ ë‹¤ë¥¸ ì›¹ì‚¬ì´íŠ¸ì— ìˆëŠ” ìì‹ ì˜ ì •ë³´ë¥¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì§ì ‘ ì œê³µí•˜ì§€ ì•Šê³  íŠ¹ì • ì–´í”Œë¦¬ì¼€ì´ì…˜ì— ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ëŠ” ê°œë°©í˜• í‘œì¤€ ê¸°ìˆ 

<br/>

**Role**
- `Resource Owner` - ìì›ì— ëŒ€í•œ ì ‘ê·¼ì„ í—ˆê°€í•´ì¤„ ìˆ˜ ìˆëŠ” ì£¼ì²´
- `Resource server` - ìì›ì„ í˜¸ìŠ¤íŒ…í•˜ëŠ” ì„œë²„
- `Client` - Resource Server ì—ì„œ ì œê³µí•˜ëŠ” ìì›ì„ ì‚¬ìš©í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜
- `Authorization Server`
    - ì‚¬ìš©ìì˜ ë™ì˜ë¥¼ ë°›ì•„ì„œ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ì„œë²„
    - ì¼ë°˜ì ìœ¼ë¡œ Resource Server ì™€ ê°™ì€ URL í•˜ìœ„ì— ìˆëŠ” ê²½ìš°ê°€ ë§ìŒ

<br/>

**Authorization Code Grant**

![image](https://user-images.githubusercontent.com/87689191/206835394-95c352aa-9661-49e6-9dc3-f571d289c53c.png)

<br/>

**Spring Security OAuth**
- ClientRegistration
    - Oauth 2.0 / OpenID Connect 1.0 providerì— ë“±ë¡í•˜ê¸° ìœ„í•œ client ì •ë³´
- CommonOAuth2Provider
    - ì‚¬ìš©ìê°€ ë§ì€ ì›¹ì„œë¹„ìŠ¤ ê¸°ì—…ë“¤ì„ Springì—ì„œ ì œê³µ
    ```java
    public enum CommonOAuth2Provider {
        GOOGLE { /*...*/ },
        GITHUB { /*...*/ },
        FACEBOOK { /*...*/ },
        OKTA { /*...*/ };
    }
    ```
- ClientRegistraionRepository
    - repository for Oauth 2.0 / OpenID Connect 1.0 ClientRegistration
- InMemoryClientRegistrationRepository
    - default implementation of ClientRegistrationRepository
    - store ClientRegistrations in-memory
- OAuth2AuthorizedClient
    - resource ownerê°€ authorization grantë¥¼ í•´ ì¤€ clientì˜ ì •ë³´ë¥¼ ì¶”ìƒí™”
- OAuth2AuthorizedClientService
    - OAuth2AuthorizedClient ê´€ë¦¬ ê¸°ëŠ¥
- InMemoryOAuth2AuthorizedClientService
    - default implementation of OAuth2AuthorizedClientService
    - store OAuth2AuthorizedClients in-memory

<br/>

**Oauth2Login**
```java
http.oauth2Login()
    .clientRegistrationRepository(clientRegistrationRepository())
    .authorizedClientService(authorizedClientService());
```

<br/>

---

### ê³¼ì œ
- Github OAuth2 ë¡œê·¸ì¸ ì¶”ê°€
- ì½”ë“œ : [ë§í¬ ğŸ”‘](https://github.com/unhas01/nhnacademy/tree/master/Week15/spring-security-subject-day2)





