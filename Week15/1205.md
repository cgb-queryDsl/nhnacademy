# 1205 ì •ë¦¬

### Spring Security 1ì¼ì°¨

<br/>

**ì´ì „ê¹Œì§€ ë¡œê·¸ì¸ ì²˜ë¦¬**
```java
@Controller
@RequestMapping("/login")
public class LoginController {

    private final String SESSION = "session";
    private final UserService userService;

    public LoginController(UserService userService) {
        this.userService = userService;
    }

    @PostMapping
    public String login(@RequestParam("id") String loginId,
                        @RequestParam("pw") String loginPw, HttpSession session) {

        Optional<User> optional = userService.getLoginUser(loginId);
        try {
            if (optional.isPresent() && optional.get().getPassword().equals(loginPw)) {
                session.setAttribute(SESSION, optional.get().getId() + "-" + optional.get().getNickname() + "-on");

                return "redirect:/community?page=1";
            }
        } catch (NoSuchElementException e) {
            return "index/index";
        }

        return "index/index";
    }
}
```
- DBí˜¹ì€ ë©”ëª¨ë¦¬ ì €ì¥ì†Œì— ì €ì¥ëœ ID & Passwordë¥¼ ë¹„êµí•˜ê³  ì¼ì¹˜í•˜ëŠ” ê²½ìš°ì— ì„¸ì…˜ì„ ë“±ë¡í•˜ëŠ” ì‹ìœ¼ë¡œ êµ¬í˜„
- **BUT** ì´ ë°©ë²•ì—ëŠ” ë¬¸ì œê°€ ìˆìŒ
    1. DBì— `password`ë¥¼ ê·¸ëƒ¥ plain textë¡œ ì €ì¥í•˜ëŠ” ë°©ë²•ì€ <span style="color:red">ì ˆëŒ€ í•´ì„  ì•ˆë˜ëŠ” ì§“</span>

<br/>

**ë‹¨ë°©í–¥ í•´ì‹œ í•¨ìˆ˜ì˜ ë‹¤ì´ì œìŠ¤íŠ¸**
- `í•´ì‹œ`ë¥¼ ì‚¬ìš©
- í•´ì‹œí•¨ìˆ˜
    - ì„ì˜ì˜ ê¸¸ì´ë¥¼ ê°–ëŠ” ì„ì˜ì˜ ë°ì´í„°ë¥¼ ê³ ì •ëœ ê¸¸ì´ì˜ ë°ì´í„°ë¡œ ë§¤í•‘í•˜ëŠ” ë‹¨ë°©í–¥ í•¨ìˆ˜
    <img width="320" alt="image" src="https://user-images.githubusercontent.com/87689191/205930764-e8387402-5f5c-4769-9e41-8ffddaed4869.png">

    - `John Smith`ì„ ê°€ì§€ê³  í•´ì‹œê°’ì€ ì•Œ ìˆ˜ ìˆìŒ
    - í•´ì‹œê°’ì„ ê°€ì§€ê³  `John Smith`ë¥¼ ì•Œ ë°©ë²•ì€ ì—†ìŒ
- í•´ì‹œì˜ íŠ¹ì„±
    - í•´ì‹œëŠ” ê³ ì • ê¸¸ì´ == ì›ë¬¸ì´ ì†ì‹¤
    - ì›ë¬¸ê³¼ í•´ì‹œ ê°’ ì‚¬ì´ì— ì„ í˜•ì ì¸ ê´€ê³„ê°€ ì—†ìŒ
- í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ ì¢…ë¥˜
    - MD5 : 128ë¹„íŠ¸ ê¸¸ì´
    - SHA-1 : 160ë¹„íŠ¸ ê¸¸ì´
    - SHA-256 : 256ë¹„íŠ¸ ê¸¸ì´


<br/>

**ë‹¨ë°©í–¥ í•´ì‹œ í•¨ìˆ˜ì˜ ë¬¸ì œì **
- ì¸ì‹ ê°€ëŠ¥ì„±
    - ë™ì¼í•œ ë©”ì‹œì§€ëŠ” ë™ì¼í•œ í•´ì‹œê°’ì„ ê°€ì§„ë‹¤.
- ì†ë„
    - í•´ì‹œ í•¨ìˆ˜ëŠ” ë¹ ë¥¸ ë°ì´í„° ê²€ìƒ‰ì„ ìœ„í•œ ëª©ì ìœ¼ë¡œ ì„¤ê³„ëœ ì•Œê³ ë¦¬ì¦˜
    - ì†ë„ê°€ ë¹ ë¥´ê¸°ì— ì„ì˜ì˜ ë¬¸ìì—´ì— ëŒ€í•´ í•´í‚¹í•  í•´ì‹œê°’ì„ ë¹„êµê°€ ê°€ëŠ¥
    - í•˜ë‚˜ì˜ ì‚¬ì „ì„ ë§Œë“¤ì–´ ëª¨ë“  ë¬¸ìì—´ ì¡°í•©ì— ëŒ€í•´ í•´ì‹œê°’ì„ ì°¾ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë‹¨ ì´ì´ê¸°

<Br/>

**Salt**
- ë‹¨ë°©í–¥ í•´ì‹œ í•¨ìˆ˜ë¥¼ í•´ê²°í•  ë°©ë²•
- ì†Œê¸ˆì„ ë¿Œë¦¬ë“¯ì´ ë°”ì´íŠ¸ ë‹¨ìœ„ì˜ ì„ì˜ì˜ ë¬¸ìì—´ì„ ì¶”ê°€í•´ì„œ Në²ˆ ë°˜ë³µì„ í•¨

<br/>

**ì˜ˆì‹œ**
- ë‹¨ë°©í–¥ í•´ì‹œ í•¨ìˆ˜
- 1024ë²ˆ ë°˜ë³µ
```java
public class PasswordUtils {
    private static final int DEFAULT_ITERATIONS = 1024;

    private PasswordUtils() {
        throw new IllegalStateException("Utility class");
    }

    public static String simple(String rawPassword) {
        byte[] digest = null;
        try {
            digest = sha256WithoutSaltAndIterations(rawPassword);
        } catch (NoSuchAlgorithmException ex) {
            log.error("", ex);
        }

        return bytesToHex(digest);
    }

    public static String encode(String rawPassword, byte[] salt) {
        return encode(rawPassword, salt, DEFAULT_ITERATIONS);
    }

    public static String encode(String rawPassword, byte[] salt, int iterations) {
        byte[] digest = null;
        try {
            digest = sha256(rawPassword, salt, iterations);
        } catch (NoSuchAlgorithmException ex) {
            log.error("", ex);
        }

        return bytesToHex(digest);
    }

    private static byte[] sha256(String rawPassword, byte[] salt, int iterations) throws NoSuchAlgorithmException {
        MessageDigest digest = MessageDigest.getInstance("SHA-256");
        digest.reset();
        digest.update(salt);

        byte[] input = digest.digest(rawPassword.getBytes(StandardCharsets.UTF_8));
        for (int i = 0; i < iterations; i++) {
            digest.reset();
            input = digest.digest(input);
        }

        return input;
    }

    private static byte[] sha256WithoutSaltAndIterations(String rawPassword) throws NoSuchAlgorithmException {
        MessageDigest digest = MessageDigest.getInstance("SHA-256");
        digest.reset();
        return digest.digest(rawPassword.getBytes(StandardCharsets.UTF_8));
    }

    public static String bytesToHex(byte[] bytes) {
        StringBuilder sb = new StringBuilder();
        for (byte b: bytes) {
            sb.append(String.format("%02x", b));
        }
        return sb.toString();
    }

}
```
- í…ŒìŠ¤íŠ¸ 
```java
@Test
void test() {
    String password = "12345";

    List<String> hashes = new ArrayList<>();

    for (int i = 0; i < 10; i++) {
        hashes.add(PasswordUtils.simple(password));
    }

    for (int i = 0; i < 10; i++) {
        assertThat(hashes.get(i)).isEqualTo("5994471abb01112afcc18159f6cc74b4f511b99806da59b3caf5a9c173cacfc5");
    }

    SecureRandom random = new SecureRandom();
    byte[] salt = new byte[8];

    hashes.clear();

    for (int i = 0; i < 10; i++) {
        random.nextBytes(salt);
        String digest = PasswordUtils.encode(password, salt);

        System.out.println("salt=" + PasswordUtils.bytesToHex(salt) + ", digest=" + digest);
        hashes.add(digest);
    }

    Set<String> set = new HashSet<>(hashes);
    assertThat(set).hasSize(10);
}
```
- "12345"ì— ëŒ€í•´ì„œëŠ” ë™ì¼í•œ í•´ì‹œ ê°’ì´ ë‚˜ì˜¤ëŠ” ê²ƒì„ ë³´ì—¬ì¤Œ
- `salt`ë¥¼ ì¶”ê°€í•˜ë©´ ê°ê¸° ë‹¤ë¥¸ í•´ì‹œ ê°’ì´ ë‚˜ì˜¤ëŠ” ê²ƒì„ ë³´ì—¬ì¤Œ
```java
// ì¶œë ¥
salt=8e86653c7a828f55, digest=7a852c92e3cea15fa22ef02d515659a08b77c4b0b05989cb7aec5150a7447a53
salt=fc110fe4fa87f483, digest=00f17ffe36048ea97b73214e871c1c30a57306f97111c77a5c65f09bae1ac709
salt=b3e636bbe3cd7ac9, digest=c822badcb082caad64ada503f69e60473c7c4fe638ce3efc45460ba8fecdadc2
salt=3cd6c044b89e6d15, digest=6cc6750b24a4be53eb06e6758d02ebf5c38f7e84e929809ac004d73f664afb66
salt=344c29bbe30ef71c, digest=d5933830fc1bfa1ef9e7ba3d5869cfe9eb6649887e86ea2b2ea449eacc5ab84a
salt=3470901922dabf09, digest=f625aed9b263c5bacee195f7f876740978a5aaa283f785d4d19cf23180da0a91
salt=209c69c6f8c9f572, digest=f07a3606cfada93beaf03ffff7676a91a5a9d772f721e5d9027b53898578e5f4
salt=dfff05be66b77232, digest=2a628d724c5516a3793473e1e6e38651f0ca0ab961d0291a23aef9fe6614d7a3
salt=119413358b0d27b4, digest=3b94d02c1591fffd5ced7172549cfc088ad7b21ee47d314eb1f3a002072eb164
salt=0676869ba1ab7855, digest=0a1f239daa08c1e50cfd442c7155e0df1ef4c1e0f6e5deaeeef56bd66d07ee18
```

<Br/>

**ì¿ í‚¤ì™€ ì„¸ì…˜**
- ì¿ í‚¤
    - ë¸Œë¼ìš°ì €ì— ì €ì¥
    - ê°œì¸ì •ë³´ë¥¼ ì¿ í‚¤ì— ì €ì¥í•˜ëŠ” ê²ƒì€ <span style="color:red">ê¸ˆë¬¼</span>
- ì„¸ì…˜
    - ì„œë²„ì— ì €ì¥

<br/>

ì„¸ì…˜ì€ ì„œë²„ì— ì €ì¥ë˜ê¸° ë•Œë¬¸ì— ë¸Œë¼ìš°ì €ë¥¼ ê»ë‹¤ê°€ ë‹¤ì‹œ í‚¤ë©´ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ê°€ ì—†ë‹¤.   
--> ìµœì†Œí•œ ì¿ í‚¤ì— ì„¸ì…˜ ì•„ì´ë””ë¥¼ ë‚¨ê²¨ë†“ì•„ì•¼ ì„¸ì…˜ê°’ì„ ì°¾ì„ ìˆ˜ ìˆë‹¤. (ì„œë²„ê°€ 2ê°œ ì´ìƒì´ë©´ ë°˜ë“œì‹œ ì±™ê²¨ì•¼í•  ë¶€ë¶„)  
--> `Redis`ë¥¼ ì£¼ë¡œ ì‚¬ìš©

---

### Spring Security

<br/>

**ë‚´ìš©**
- Spring ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìœ„í•´ ì„ ì–¸ì  ë³´ì•ˆ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ë³´ì•ˆ í”„ë ˆì„ì›Œí¬
- **Servlet Filter** ë° **AOP ê¸°ë°˜**

<Br/>

**ì§€ì›í•˜ëŠ” Authentication Models**
- HTTP BASIC authentication headers
- HTTP Digest authentication headers
- HTTP X.509 client certificate exchange
- Form-based authentication
- LDAP
- CAS (Jasig Central Authentication Service)
- Authentication based on pre-established request headers ex.) CA Siteminder
- Kerberos
- OpenID authentication
- OAuth 2.0 / OpenID Connect(OIDC) 1.0
- SAML 2.0

<br/>

**Spring Security Modules**

<br/>

**Core** : spring-security-core
- core authentication, access-control

**Config** : spring-security-config
- XML namespace configuration
- Java Config

**Web** : spring-security-web
- filters, web security infrastructure

**Taglibs**: spring-security-taglibs
- JSP tag êµ¬í˜„

<br/>

**Spring Security Modules (Advanced)**

<br/>

**ACL** : spring-security-acl
- domain object ACL

**Remoting** : spring-security-remoting
- provides integration with Spring Remoting

**Test** : spring-security-test
- support for testing with Spring Security

**Spring Security 5 OAuth 2.0 Modules**

<br/>

**OAuth 2.0 Core : spring-security-oauth2-core**
- core classes and interfaces for OAuth 2.0 Authorization Framework and OpenID Connect Core 1.0

**OAuth 2.0 Client : spring-security-oauth2-client**
- client support for OAuth 2.0 Authorization Framework and OpenID Connect Core 1.0
- íŠ¹íˆ, OAuth 2.0 Login

<br/>

**Spring Security ì„¤ì •**

<br/>

- `pom.xml` ì„¤ì •
```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-bom</artifactId>
            <version>5.6.5</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>


<dependencies>
    <dependency>
        <groupId>org.springframework.security</groupId>
        <artifactId>spring-security-config</artifactId>
    </dependency>

    <dependency>
        <groupId>org.springframework.security</groupId>
        <artifactId>spring-security-web</artifactId>
    </dependency>

    <dependency>
        <groupId>org.springframework.security</groupId>
        <artifactId>spring-security-taglibs</artifactId>
    </dependency>
</dependencies>
```


**xml ì„¤ì • ë°©ë²•**

<details>
    <summary> xml ì„¤ì • ë°©ë²• </summary>

- `web.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
         version="4.0">
    <filter>
        <filter-name>springSecurityFilterChain</filter-name>
        <filter-class>org.springframework.web.filter.DelegatingFilterProxy</filter-class>
    </filter>

    <filter-mapping>
        <filter-name>springSecurityFilterChain</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>

</web-app>
```

- `SecurityConfig`
```java
@EnableWebSecurity(debug = true)
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
                .antMatchers("/admin/**").hasAuthority("ROLE_ADMIN")
                .antMatchers("/private-project/**").hasAnyAuthority("ROLE_ADMIN", "ROLE_MEMBER")
                .antMatchers("/project/**").authenticated()
                .antMatchers("/redirect-index").authenticated()
                .anyRequest().permitAll()
                .and()
            .formLogin()
                .and()
            .logout()
                .and()
            .csrf()
                .disable()
            .sessionManagement()
                .sessionFixation()
                    .none();
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.inMemoryAuthentication()
            .withUser("admin")
                .password("{noop}admin")
                .authorities("ROLE_ADMIN")
                .and()
            .withUser("member")
                .password("{noop}member")
                .authorities("ROLE_MEMBER")
                .and()
            .withUser("guest")
                .password("{noop}guest")
                .authorities("ROLE_GUEST");
    }
}
```

</details>

<br/>

**WebApplicationInitializer ì„¤ì • ë°©ë²•**
- `web.xml` ì—†ì´ SpringSecurityFilterChain êµ¬ì„± ê°€ëŠ¥
```java
public class SecurityInitializer extends AbstractSecurityWebApplicationInitializer {
}
```

<Br/>

**Spring Security 5.7.0 ì´í›„ ì„¤ì • ë°©ë²•**
- `WebSecurityConfigurerAdapter`ê°€ ë”ì´ìƒ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë°©ë²•ìœ¼ë¡œ ë°”ë€œ
- OverrideëŒ€ì‹  Beanìœ¼ë¡œ ë“±ë¡
```java
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        return http.authorizeRequests()
                .antMatchers("/admin/**").hasAuthority("ROLE_ADMIN")
                .antMatchers("/private-project/**").hasAnyAuthority("ROLE_ADMIN", "ROLE_MEMBER")
                .antMatchers("/project/**").authenticated()
                .antMatchers("/redirect-index").authenticated()
                .anyRequest().permitAll()
                .and()
            .formLogin()
                .and()
            .logout()
                .and()
            .csrf()
                .disable()
            .sessionManagement()
                .sessionFixation()
                    .none()
                .and()
            .build();
    }

    @Bean
    public InMemoryUserDetailsManager userDetailsService() throws Exception {
        UserDetails admin = User.withUsername("admin")
                .password("{noop}admin")
                .authorities("ROLE_ADMIN")
                .build();

        UserDetails member = User.withUsername("member")
                .password("{noop}member")
                .authorities("ROLE_MEMBER")
                .build();

        UserDetails guest = User.withUsername("guest")
            .password("{noop}guest")
            .authorities("ROLE_GUEST")
            .build();

        return new InMemoryUserDetailsManager(admin, member, guest);
    }

}
```

<br/>

**ë³´ì•ˆ í•„í„° ì²´ì¸**
- `springSecurityFilterChain`ì´ë¦„ì˜ beanìœ¼ë¡œ í•„í„° ì²˜ë¦¬ë¥¼ ëª¨ë‘ ìœ„ì„
- íƒ€ì…
    - org.springframework.security.web.FilterChainProxy

<br/>

**Spring Security Filter Chain**
- ê°ê° í•„í„°ë“¤ì€ íŠ¹ë³„í•œ ì—­í• ì„ ê°€ì§€ê³  ìˆìŒ
- ì˜ì¡´ê´€ê³„ê°€ ìˆê¸° ë•Œë¬¸ì— ìˆœì„œê°€ ì¤‘ìš”
- í•„í„° ì¢…ë¥˜
```java
enum SecurityFilters {
    FIRST(Integer.MIN_VALUE),
    CHANNEL_FILTER,
    SECURITY_CONTEXT_FILTER,
    CONCURRENT_SESSION_FILTER,
    WEB_ASYNC_MANAGER_FILTER,
    HEADERS_FILTER,
    CORS_FILTER,
    CSRF_FILTER,
    LOGOUT_FILTER,
    X509_FILTER,
    PRE_AUTH_FILTER,
    CAS_FILTER,
    FORM_LOGIN_FILTER,
    OPENID_FILTER,
    LOGIN_PAGE_FILTER,
    DIGEST_AUTH_FILTER,
    BEARER_TOKEN_AUTH_FILTER,
    BASIC_AUTH_FILTER,
    REQUEST_CACHE_FILTER,
    SERVLET_API_SUPPORT_FILTER,
    JAAS_API_SUPPORT_FILTER,
    REMEMBER_ME_FILTER,
    ANONYMOUS_FILTER,
    SESSION_MANAGEMENT_FILTER,
    EXCEPTION_TRANSLATION_FILTER,
    FILTER_SECURITY_INTERCEPTOR,
    SWITCH_USER_FILTER,
    LAST(Integer.MAX_VALUE);
}
```

<Br/>

**ì£¼ìš” í•„í„°**

**ChannelProcessingFilter**
- redirect to a different protocol (http â†’ https)

**SecurityContextPersistenceFilter**
- SecurityContext ê°ì²´ë¥¼ SecurityContextHolderì— ì €ì¥
    - ì–´ë””ì— ì €ì¥? SecurityContextRepository (default: HttpSession)
- ìš”ì²­ ì²˜ë¦¬ê°€ ëë‚˜ë©´ ì œê±°

**ConcurrentSessionFilter**
- í˜„ì¬ Session ìœ íš¨ ì—¬ë¶€ íŒŒì•…í•˜ì—¬ ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì— ëŒ€í•œ í›„ì²˜ë¦¬
- SessionManagementFilterì™€ ì—°ë™ ì²˜ë¦¬

**HeaderWriterFilter**
- í˜„ì¬ ìš”ì²­ì— HTTP Header ì¶”ê°€
- Ex.)
    - Cache-Control
    - X-Content-Type-Options
    - X-Frame-Options

**CsrfFilter**
- Csrf (Cross-site Request Forgery: ì‚¬ì´íŠ¸ ê°„ ìš”ì²­ ìœ„ì¡°) ê³µê²©ì„ ë§‰ê¸° ìœ„í•œ ì²˜ë¦¬

**LogoutFilter**
- íŠ¹ì • URIë¥¼ ì²´í¬í•˜ì—¬ Logoutì„ ì‹¤í–‰
- Logout ì²˜ë¦¬ (LogoutHandler)
- Logout ì„±ê³µ í›„ ì²˜ë¦¬ (LogoutSuccessHandler)

**PRE_AUTH_FILTER**
- AbstractPreAuthenticatedProcessingFilterë¥¼ ìƒì†ë°›ì•„ êµ¬í˜„
- Ex.)
    - X.509

**CasAuthenticationFilter**
- JA-SIGâ€™s CAS(Central Authentication Service) Single Sign On system
    - cf.) https://www.apereo.org/projects/cas

**UsernamePasswordAuthenticationFilter**
- íŠ¹ì • URLì—ì„œ username, passwordë¥¼ í†µí•œ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ ì§„í–‰
- ì¸ì¦ ì²˜ë¦¬ëŠ” AuthenticationManagerì—ê²Œ ìœ„ì„
- ì¸ì¦ ì„±ê³µ ì²˜ë¦¬ (SuccessHandler)
- ì¸ì¦ ì‹¤íŒ¨ ì²˜ë¦¬ (FailureHandler)

**RequestCacheAwareFilter**
- ì¸ì¦ ì„±ê³µ í›„ ê¸°ì¡´ ìš”ì²­ì„ ì°¾ì•„ê°€ê¸° ìœ„í•´ ê¸°ì¡´ ìš”ì²­ì„ ì €ì¥
    - ì–´ë””ì— ì €ì¥? RequestCache (default: HttpSession)
        - session attribute : SPRING_SECURITY_SAVED_REQUEST

**AnonymousAuthenticationFilter**
- ì¸ì¦ì´ ì•ˆ ëœ ì‚¬ìš©ìì—ê²Œ anonymousUserë¼ëŠ” ì´ë¦„ì˜ Authentication ê°ì²´ë¥¼ ì„¤ì •í•˜ê³ 
- `ROLE_ANONYMOUS` ê¶Œí•œì„ ë¶€ì—¬

**SessionManagementFilter**
- ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ, ë™ì‹œ ì ‘ê·¼ ì œì–´ ë“±ì„ ì²˜ë¦¬

**ExceptionTranslationFilter**
- ì´ í•„í„° ì´í›„ì˜ ëª¨ë“  ì¸ì¦(AuthenticationException), ê¶Œí•œ(AccessDeniedException) ì˜ˆì™¸ ì²˜ë¦¬

**FilterSecurityInterceptor**
- ê¶Œí•œ í”„ë¡œì„¸ìŠ¤ë¥¼ ì²˜ë¦¬í•˜ëŠ” Filter
    - cf.) AbstractSecurityInterceptor
    - `<intercept-url />` ë‚´ìš©ì„ ê¸°ì¤€ìœ¼ë¡œ ê¶Œí•œ ì²˜ë¦¬

<br/>

**Spring Security ê¸°ë³¸ ê°œë…**

**Authentication (ì¸ì¦: authn)**
- ìì‹ ì´ ëˆ„êµ¬ë¼ê³  ì£¼ì¥í•˜ëŠ” ì£¼ì²´ë¥¼ í™•ì¸í•˜ëŠ” í”„ë¡œì„¸ìŠ¤
- (the process of determining whether who or what it declares itself to be)
    - ì£¼ì²´ (principal) : ì‚¬ìš©ì, ë””ë°”ì´ìŠ¤, ë‹¤ë¥¸ ì‹œìŠ¤í…œ
**Authorization (ì¸ê°€, ê¶Œí•œ ë¶€ì—¬: authz)**
- ì–´í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì—ì„œ ì£¼ì²´ê°€ ì–´ë–¤ í–‰ìœ„ë¥¼ ìˆ˜í–‰í•˜ë„ë¡ í—ˆë½ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ëŠ” í”„ë¡œì„¸ìŠ¤

<br/>

**Security Context**
- Authenticationì„ ë³´ê´€í•˜ëŠ” ì—­í• 
- Authentication Getter / Setter

<br/>

**Security ContextHolder**
- ThreadLocalì— SecurityContext ì €ì¥

<img width="506" alt="image" src="https://user-images.githubusercontent.com/87689191/206828885-914dfd15-1ab6-471d-a083-a0822531d816.png">

<br/>

**UserDetails**
```java
interface Authentication {
    Object getPrincipal();s
}
```
- `ì£¼ì²´` (principal)ì€ ê°ì²´ -> `UserDetails` ê°ì²´ë¡œ cast ë¨
- DBì— ì €ì¥ë˜ì–´ ìˆëŠ” ì‚¬ìš©ì ì •ë³´ì™€ SecurityContextHolderì— ì €ì¥ë  ì •ë³´ ì‚¬ì´ì˜ Adapterë¼ ìƒê°í•˜ë©´ ë¨

<Br/>

**UserDetailsService**
- `UserDetails`ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ DAO êµ¬í˜„
```java
public interface UserDetailsService {
    UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;
}
```

<Br/>

**GrantedAuthority**
- ì–´í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì—ì„œ ì£¼ì²´ì— ë¶€ì—¬ëœ ê¶Œí•œ

<br/>

**ì¸ì¦ ì²˜ë¦¬**

**AuthenticationManager**
```java
public interface AuthenticationManager {
    Authentication authenticate(Authentication authentication) throws AuthenticationException;
}
```

<br/>

**ProviderManager**
- AuthenticationManager ê¸°ë³¸ êµ¬í˜„
- AuthenticationProvider(s)ë¡œ ìœ„ì„

<br/>

<img width="349" alt="image" src="https://user-images.githubusercontent.com/87689191/206829361-713359f1-912c-4cd7-a324-100fce318ee4.png">
<img width="373" alt="image" src="https://user-images.githubusercontent.com/87689191/206829367-fda4defe-6f52-43d4-8687-e4f94723d3f9.png">


<br/>

**Custom UserDetailsService êµ¬í˜„ ì‹¤ìŠµ**

- login.html
- `name="id"` : `usernameParameter("id")`ì— ë§¤ì¹­
- `name="pwd"` : `passwordParameter("pwd")`ì— ë§¤ì¹­
```html
<body>
    <form method="post" action="/login">
        ID: <input type="text" name="id" /><br />
        Password: <input type="password" name="pwd" /><br />
        <input type="submit" />
    </form>
</body>
```
- SecurityConfig
```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    http.authorizeRequests()
            .anyRequest().permitAll()
            .and()
        .formLogin()
            .usernameParameter("id")
            .passwordParameter("pwd")
            .and()
        .logout()
            .and()
        .csrf()
            .disable()
        .sessionManagement()
            .sessionFixation()
                .none();
}

@Bean
public AuthenticationProvider authenticationProvider(CustomUserDetailsService customUserDetailsService) {
    DaoAuthenticationProvider authenticationProvider = new DaoAuthenticationProvider();
    authenticationProvider.setUserDetailsService(customUserDetailsService);
    authenticationProvider.setPasswordEncoder(passwordEncoder());

    return authenticationProvider;
}

@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```

- CustomUserDetailsService
```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    private final MemberRepository memberRepository;

    public CustomUserDetailsService(MemberRepository memberRepository) {
        this.memberRepository = memberRepository;
    }

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        return memberRepository.findById(username)
            .orElseThrow(() -> new UsernameNotFoundException(username + " not found"));
    }
}
```

<br/>

**ì‹¤ìŠµ ì •ë¦¬**
1. login.htmlì—ì„œì˜ `action="/login`ì€ Spring Securityì—ì„œ ì œê³µí•˜ëŠ” Controller
1. usernameParameter("id") & passwordParameter("pwd")ì— ë“¤ì–´ì™„ idì™€ passwordë¥¼ ê°€ì§€ê³  ë¡œê·¸ì¸ì„ Spring Securityì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì²˜ë¦¬
1. ê¸°ë³¸ì ìœ¼ë¡œ `UserDetailsService`ì—ì„œ ì²˜ë¦¬í•˜ì§€ë§Œ ì´ë¥¼ ìƒì†ë°›ì•„ ì»¤ìŠ¤í…€ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥
1. DBì—ì„œ ì°¾ì€ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì§€ê³  ì¸ì¦ì„ ì²˜ë¦¬í•´ì¤Œ

<br/>

**logout()**
- delete-cookies
    - ì‚­ì œí•  ì¿ í‚¤ ì´ë¦„ì„ ì§€ì •í•´ì„œ ì‚­ì œ
- logout-success-url
    - ë¡œê·¸ì•„ì›ƒ ì„±ê³µ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë  url

<br/>

**ê¶Œí•œì´ ì—†ëŠ” ê²½ìš°**
- ê¶Œí•œì´ ì—†ì–´ì„œ ìƒê¸°ëŠ” ì˜¤ë¥˜ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë  url
- `accessDeniedPage()`

<br/>

**ì›¹ ìš”ì²­ ACL í‘œí˜„ì‹**

|í‘œí˜„ì‹	| ì„¤ëª…|
|---|---|
|hasRole('ê¶Œí•œ') <br/> hasAuthority('ê¶Œí•œ') | í•´ë‹¹ ê¶Œí•œì„ ê°€ì¡ŒëŠ”ê°€? |
|hasAnyRole('ê¶Œí•œ1','ê¶Œí•œ2') <br/> hasAnyAuthority('ê¶Œí•œ1','ê¶Œí•œ2') |	ì§€ì •í•œ ê¶Œí•œ ì¤‘ í•˜ë‚˜ë¼ë„ ê°€ì¡ŒëŠ”ê°€?|
|permitAll |	ëª¨ë‘ í—ˆìš©|
|denyAll |	ëª¨ë‘ ê±°ë¶€|
|isAnonymous() |	ìµëª… ì‚¬ìš©ìì¸ê°€?|
|isAuthenticated()	|ì¸ì¦ëœ ì‚¬ìš©ìì¸ê°€?|
|hasIpAddress('ip)| 	IPë‚˜ IPëŒ€ì—­ì— í¬í•¨ë˜ëŠ”ê°€? (web ë³´ì•ˆì—ì„œë§Œ ê°€ëŠ¥)|

<br/>


**Spring Security JSP Tag Library**

- Thymeleafì—ì„œ Tag ì‚¬ìš©

- pom.xml ì˜ì¡´ì„± ì¶”ê°€
```xml
<dependency>
    <groupId>org.thymeleaf.extras</groupId>
    <artifactId>thymeleaf-extras-springsecurity5</artifactId>
    <version>3.0.4.RELEASE</version>
</dependency>
```
- WebConfig ì¶”ê°€
```java
templateEngine.addDialect(new SpringSecurityDialect());
```

- Thymeleaf NameSpace ì„ ì–¸
```html
<html lang="ko" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
</html>
```

<Br/>

**ì‚¬ìš© ì˜ˆì‹œ**
```html
<sec:authorize url="/public-project/2">
<li sec:authorize-url="/public-project/2">
<div sec:authentication="principal.username"/>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
```

<br/>


### ê³¼ì œ
- Spring Securityë¥¼ ì´ìš©í•´ ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„
- ì½”ë“œ : [ë§í¬ ğŸ”‘](https://github.com/unhas01/nhnacademy/tree/master/Week15/spring-security-subject-day1)





