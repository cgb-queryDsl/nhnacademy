# 1207 ì •ë¦¬

### Spring Security ê²°ì‚° ê³¼ì œ

<br/>

**ê³¼ì œ**
- [14ì£¼ì°¨ ê³¼ì œ](https://github.com/unhas01/nhnacademy/blob/master/Week14/1201.md)ë¥¼ ê°€ì§€ê³  ì§„í–‰
- ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ì¶”ê°€
- ì£¼ë¯¼(resident) í…Œì´ë¸”ì— 3ê°œ ì¹¼ëŸ¼ ì¶”ê°€
    - ì•„ì´ë””
    - ë¹„ë°€ë²ˆí˜¸
    - ì´ë©”ì¼
- ë¹„ë°€ë²ˆí˜¸ëŠ” plain textë¡œ ì €ì¥í•˜ì§€ ì•ŠìŒ
    - ë‹¨ë°©í–¥ hash í•¨ìˆ˜ì˜ digest ê¸°ë°˜ìœ¼ë¡œ ì €ì¥

<br/>

**ê¸°ëŠ¥ ì¶”ê°€**
- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ ì¶”ê°€
    - ì¸ì¦ ì¿ í‚¤ì˜ ExpireëŠ” 3ì¼
    - ì„¸ì…˜ì€ Redisì— ì €ì¥
- ì£¼ë¯¼ ëª©ë¡
    - ì „ì²´ ì£¼ë¯¼ ëª©ë¡ì´ ì•„ë‹Œ ë¡œê·¸ì¸í•œ ë³¸ì¸ì˜ ì„¸ëŒ€ì— ì†í•˜ëŠ” ì£¼ë¯¼ë“¤ë§Œ ëª©ë¡ìœ¼ë¡œ ë·°

<br/>

**OAuth2 ì¸ì¦ ì¶”ê°€**
- ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ê³¼ OAuth2 ì¸ì¦ì„ ë™ì‹œì— ì œê³µ
- Github ë¡œê·¸ì¸ ì œê³µ
    - Spring Security ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´ìš©í•˜ì§€ ì•Šê³  Github APIë¥¼ ì´ìš©í•´ì„œ ì§ì ‘ êµ¬í˜„
    - [Github API ë¬¸ì„œ](https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps#web-application-flow)
    - Github emailê°’ì´ ì‹¤ì œ resident í…Œì´ë¸”ì— ìˆëŠ” ê°’ì¸ ê²½ìš°ì—ë§Œ ë¡œê·¸ì¸

<Br/>

**ì½”ë“œ**
- [ë§í¬ ğŸ”‘](https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps#web-application-flow)
- OAuth2 API ì½”ë“œ
    <details>
        <summary> processOauthLogin() </summary>

    ```java
    public void processOauthLogin(String code, HttpServletRequest request) {
        restTemplate = new RestTemplate();

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);

        MultiValueMap<String, String> params = new LinkedMultiValueMap<>();
        params.add("client_id", clientId);
        params.add("client_secret", clientSecret);
        params.add("code", code);
        params.add("redirect_uri", redirectUri);

        HttpEntity<MultiValueMap<String, String>> oauthRequest = new HttpEntity<>(params, headers);
        ResponseEntity<AccessToken> response = restTemplate.exchange(ACCESS_URL, HttpMethod.POST, oauthRequest, AccessToken.class);

        String accessToken = response.getBody().getAccess_token();

        headers = new HttpHeaders();
        headers.setBearerAuth(accessToken);

        HttpEntity<String> userInfoEntity = new HttpEntity<>(headers);
        ResponseEntity<UserInfo> userInfo = restTemplate.exchange(API_URL, HttpMethod.GET, userInfoEntity, UserInfo.class);

        String email = userInfo.getBody().getEmail();
        Resident resident = residentRepository.getResidentByEmail(email);

        if (Objects.nonNull(resident)) {
            SecurityContext securityContext = SecurityContextHolder.createEmptyContext();
            Authentication authentication =
                    new TestingAuthenticationToken(resident.getResidentSerialNumber()+"-"+resident.getName(),
                            resident.getPassword(), "ROLE_USER");

            securityContext.setAuthentication(authentication);
            SecurityContextHolder.setContext(securityContext);
        }
    }
    ```

    </details>